define(["require","exports","./function_helpers","../scripts/main","../scripts/helpers/units_conversion"],function(e,t,o,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a;!function(e){function t(e){l(),$("#sceneTree").jstree("deselect_all");var t="",o="",n=0,r=0,i=function(e){var a=!1;e.pageX<n?t="left":e.pageX>n&&(t="right"),e.pageY<r?o="top":e.pageY>r&&(o="bottom"),"left"===t&&parseFloat(Z.style.width)<=1&&(k=!1,X=!0,a=!0),"right"===t&&parseFloat(Z.style.width)<=1&&(k=!0,X=!1,a=!0),"top"===o&&parseFloat(Z.style.height)<=1&&(Y=!0,U=!1,a=!0),"bottom"===o&&parseFloat(Z.style.height)<=1&&(Y=!1,U=!0,a=!0),a&&F(e),n=e.pageX,r=e.pageY},s=function(){a(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s),F(Be)}function a(){k=!1,X=!1,Y=!1,U=!1}function i(e){a(),d(),l()}function l(){document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",L),document.addEventListener("mousemove",P),document.addEventListener("mouseup",L)}function s(e,t,o,n,r){for(var a=0;a<e.length;a++)e[a].addEventListener("mousedown",function(e){e.preventDefault(),e.stopPropagation(),F(e)}),e[a].addEventListener("mouseover",function(){Y=t,X=o,k=n,U=r}),e[a].addEventListener("mouseout",function(){Y=!1,X=!1,k=!1,U=!1})}function d(){de=Z.getElementsByClassName("top-left-corner"),ue=Z.getElementsByClassName("top-right-corner"),pe=Z.getElementsByClassName("bottom-left-corner"),ge=Z.getElementsByClassName("bottom-right-corner"),fe=Z.getElementsByClassName("left-center"),me=Z.getElementsByClassName("right-center"),ce=Z.getElementsByClassName("top-center"),he=Z.getElementsByClassName("bottom-center"),s(de,!0,!0,!1,!1),s(ue,!0,!1,!0,!1),s(pe,!1,!0,!1,!0),s(ge,!1,!1,!0,!0),s(fe,!1,!0,!1,!1),s(me,!1,!1,!0,!1),s(ce,!0,!1,!1,!1),s(he,!1,!1,!1,!0)}function u(){if("create"!==Ce){var e=n.default.openFiles[se].runtimeEditor.mappedWidgets[le.id].widget.geometry,t=o.default.getUnitStyle(e.width),a=o.default.getUnitStyle(e.height),i=o.default.getUnitStyle(e.top),l=o.default.getUnitStyle(e.left),s=getComputedStyle(le.parentElement,null),d=parseFloat(s.getPropertyValue("width")),u=parseFloat(s.getPropertyValue("height")),p=le.style;if("%"===i){var g=r.default.convertPercentToPixel(parseFloat(e.top),u);p.top=g+"px"}if("%"===l){var f=r.default.convertPercentToPixel(parseFloat(e.left),d);p.left=f+"px"}if("%"===t){var m=r.default.convertPercentToPixel(parseFloat(e.width),d);p.width=m+"px"}if("%"===a){var c=r.default.convertPercentToPixel(parseFloat(e.height),u);p.height=c+"px"}}}function p(){return this}function g(){return this}function f(){return this}function m(){return this}function c(){return this}function h(){return this}function E(){return this}function y(){return this}function v(e){return new WebKitCSSMatrix(window.getComputedStyle(e).webkitTransform)}function F(e){Se=le.style.width,Te=le.style.height,q=$("#scene")[0],n.default.openFiles[se].runtimeEditor.onResizeElStart(),Ee=e.clientX,ye=e.clientY,ve=parseFloat(r.default.convertUnitsToPixel(le.id,le.style.width,"width")),Fe=parseFloat(r.default.convertUnitsToPixel(le.id,le.style.height,"height")),x(e);var t=k||U||Y||X;Me={x:Pe,y:we,cx:e.clientX,cy:e.clientY,isResizing:t,onTopEdge:Y,onLeftEdge:X,onRightEdge:k,onBottomEdge:U},A=parseFloat(getComputedStyle(le,null).getPropertyValue("border-left-width")),H=parseFloat(getComputedStyle(le,null).getPropertyValue("border-right-width")),O=parseFloat(getComputedStyle(le,null).getPropertyValue("border-top-width")),G=parseFloat(getComputedStyle(le,null).getPropertyValue("border-bottom-width")),J=parseFloat(getComputedStyle(le,null).getPropertyValue("margin-left")),Q=parseFloat(getComputedStyle(le,null).getPropertyValue("margin-right")),ee=parseFloat(getComputedStyle(le,null).getPropertyValue("margin-top")),te=parseFloat(getComputedStyle(le,null).getPropertyValue("margin-bottom")),oe=parseFloat(getComputedStyle(le,null).getPropertyValue("padding-left")),ne=parseFloat(getComputedStyle(le,null).getPropertyValue("padding-right")),re=parseFloat(getComputedStyle(le,null).getPropertyValue("padding-top")),ae=parseFloat(getComputedStyle(le,null).getPropertyValue("padding-bottom")),Ne=H+A+J+Q+oe+ne,ze=G+O+ee+te+re+re,Me.onBottomEdge&&Me.onLeftEdge?(u(),f()):Me.onTopEdge&&Me.onRightEdge?(u(),m()):Me.onBottomEdge||Me.onRightEdge?(u(),p()):(Me.onTopEdge||Me.onLeftEdge)&&(u(),g())}function P(e){x(e)}function w(){Re.transform(le);var e=o.default.getTransformedElMaskPos(le);Z.style.width=e.width+"px",Z.style.height=e.height+"px",Z.style.top=e.top+"px",Z.style.left=e.left+"px"}function x(e){var t,o,r;if(Me&&Me.isResizing){var a,i,l=n.default.openFiles[se].runtimeEditor;if(window.requestAnimationFrame(function(){w()}),xe=e.clientX-Ee,Le=e.clientY-ye,("create"===l.interactElementsState||Fe===ve)&&e.shiftKey&&(Me.onLeftEdge&&Me.onTopEdge||Me.onLeftEdge&&Me.onBottomEdge||Me.onRightEdge&&Me.onTopEdge||Me.onRightEdge&&Me.onBottomEdge)&&(l.equalProportion=!0,Le=xe,Me.onRightEdge&&Me.onTopEdge&&(Le=-xe)),j=n.default.openFiles[se].runtimeEditor.tab.sceneTransformMatrix[0],Me.onRightEdge&&"auto"!==Se){if(e.shiftKey&&(Me.onBottomEdge||Me.onTopEdge)){var s=1,d=xe;Fe>ve&&(d=Le,s=ve/Fe,Me.onTopEdge&&(d=-d)),t=ve+d*s/j-Ne}else t=ve+xe/j-Ne;t<0&&(t=0),le.style.width=t+"px"}if(Me.onBottomEdge&&"auto"!==Te){if(e.shiftKey&&Me.onRightEdge){var s=1,d=Le;Fe<ve&&(d=xe,s=Fe/ve),o=Fe+d*s/j-ze}else o=Fe+Le/j-ze;o<0&&(o=0),le.style.height=o+"px"}if(Me.onLeftEdge&&"auto"!==Se){var d=xe,s=1;if(e.shiftKey&&Me.onBottomEdge||Me.onTopEdge){Me.onBottomEdge&&(d=-d),ve<Fe&&(d=Le,s=ve/Fe);var u=ve+d*s/j;Me.onTopEdge&&(u=ve-d*s/j),t=Math.max(Math.floor(u),be)}else t=Math.max(Math.floor(ve-xe/j),be);if(e.shiftKey&&Me.onBottomEdge){var p=void 0;p=ve>Fe?Fe+d*(s=Fe/ve)/j:Fe+d/j,o=Math.max(Math.floor(p),Ve),r=getComputedStyle(le,null),a=parseFloat(r.getPropertyValue("height"))-o,i=parseFloat(r.getPropertyValue("top"))+a,le.style.height=o-ze+"px"}if(t>=be+Ne){r=getComputedStyle(le,null);var g=parseFloat(r.getPropertyValue("width"))-t,f=parseFloat(r.getPropertyValue("left"))+g;le.style.width=t-Ne+"px",le.style.left=f+Ne+"px","create"===l.interactElementsState&&le.style.width!==le.style.height&&e.shiftKey&&Me.onBottomEdge&&Me.onLeftEdge&&(le.style.height=parseFloat(t)+"px")}}if(Me.onTopEdge&&"auto"!==Te){var s=1,d=Le;if(ve>Fe?(d=xe,s=Fe/ve):Me.onRightEdge&&(d=-d),e.shiftKey&&(Me.onLeftEdge||Me.onRightEdge)?(Me.onLeftEdge&&(d=-d),o=Math.max(Math.floor(Fe+d*s/j),Ve)):o=Math.max(Math.floor(Fe-Le/j),Ve),o>=Ve+ze&&(r=getComputedStyle(le,null),a=parseFloat(r.getPropertyValue("height"))-o,i=parseFloat(r.getPropertyValue("top"))+a,le.style.height=o-ze+"px",le.style.top=i+ze+"px","create"===l.interactElementsState&&le.style.width!==le.style.height&&e.shiftKey&&Me.onTopEdge&&Me.onRightEdge)){var m=parseFloat(le.style.width)-parseFloat(le.style.height);le.style.height=parseFloat(t)+"px",le.style.top=parseFloat(le.style.top)-m+"px"}}return _=!0,void n.default.openFiles[se].runtimeEditor.onResizeElMove(le)}_=!1,Z.style.cursor=k&&U||X&&Y?"nwse-resize":k&&Y||U&&X?"nesw-resize":k||X?"ew-resize":U||Y?"ns-resize":"default"}function L(e){Me&&(Me.onBottomEdge&&Me.onLeftEdge?E():Me.onTopEdge&&Me.onRightEdge?y():Me.onTopEdge||Me.onLeftEdge?h():(Me.onBottomEdge||Me.onRightEdge)&&c()),Me=null,!0===_&&(n.default.openFiles[se].runtimeEditor.onResizeElEnd(le,e),_=!1)}function S(e){for(var t=document.getElementsByClassName(e),o=0;o<t.length;o++)t[o].addEventListener("mousedown",function(e){e.stopPropagation(),z(e)})}function T(e){S("bottom-left-rotate"),S("top-left-rotate"),S("bottom-right-rotate"),S("top-right-rotate"),document.getElementById("center-pane").addEventListener("mouseup",I),document.getElementById("center-pane").addEventListener("mousemove",K)}function B(e){if(Ie){n.default.openFiles[se].runtimeEditor.onRotateElMove();var t,o;t=M(e);var r=Ye+(o=t-Xe);isNaN(r)&&(r=Ye);var a=_e+o;isNaN(a)&&(a=_e),Xe=t;var i="rotateZ("+a+"rad)",l=/rotateZ\((.*?)\)/,s=le.style.WebkitTransform;if(!s.match(l)){var d=n.default.openFiles[se].runtimeEditor;d._skipUndoRedoSteps=1;var u=d.mappedWidgets[ie].widget;return void d._setTransform(null,u,ie,"transform","rotateZ","0deg")}var p=s=s.replace(l,i);Z.style.WebkitTransform="rotateZ("+r+"rad)",le.style.WebkitTransform=p,Ye=r,_e=a}}function C(e){for(var t=e,o=t.offsetLeft,n=t.offsetTop;t=t.offsetParent;)o+=t.offsetLeft;for(var r=Z;r=r.offsetParent;)n+=r.offsetTop;return[o,n]}function R(e){return[e.offsetWidth,e.offsetHeight]}function b(e){return[C(e)[0]+R(e)[0]/2,C(e)[1]+R(e)[1]/2]}function V(e){return[e.pageX,e.pageY]}function M(e){var t;Ke=C(le),We=R(le),ke=b(le),Ue=V(e);try{t=Math.atan2(Ue[1]-ke[1],Ue[0]-ke[0])}catch(e){console.error(e)}return(t+=Ze/4)<0&&(t+=Ze),t}function N(e,t){t?(e.preventDefault(),Xe=M(e),Ie=!0):Ie=!1}function z(e){n.default.openFiles[se].runtimeEditor.onRotateElStart();var t=W(Z),o=W(le);Ye=t.rad,_e=o.rad,q=$("#scene")[0],D=v(q),N(e,!0)}function I(e){var t={rad:_e,deg:o.default.toDegrees(_e)};n.default.openFiles[se].runtimeEditor.onRotateElEnd(le,t),N(e,!1)}function K(e){B(e)}function W(e,t){var r={rad:0,deg:0},a=window.getComputedStyle(e,null).getPropertyValue("-webkit-transform");return(a=a.match("matrix\\((.*)\\)"))?void 0!==(a=a[1].split(","))[0]&&void 0!==a[1]&&(r.rad+=Math.atan2(a[1],a[0]),r.deg+=parseFloat((180*r.rad/Math.PI).toFixed(1))):null!==e.id&&""!==e.id&&n.default.openFiles[n.default.selectedEditor].runtimeEditor.mappedWidgets[e.id].widget.transform&&(r.deg=parseFloat(n.default.openFiles[n.default.selectedEditor].runtimeEditor.mappedWidgets[e.id].widget.transform.rotateZ)||0,r.rad=o.default.toRadians(r.deg)),r}var k,U,X,Y,_,Z,q,D,j,A,H,O,G,J,Q,ee,te,oe,ne,re,ae,ie,le,se,de,ue,pe,ge,fe,me,ce,he,Ee,ye,ve,Fe,Pe,we,xe,Le,Se,Te,Be,Ce,Re,be=0,Ve=0,Me=null,Ne=0,ze=0;e.Interact=function(e,o,r,a){ie=e.id,le=e,se=o,Be=a,Ce=r,Re=n.default.openFiles[n.default.selectedEditor].runtimeEditor.transform,Z=document.getElementsByClassName(r+"-corners")[0],"rotate"===r?(document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",L),T()):"create"===r?(document.getElementById("center-pane").removeEventListener("mouseup",I),document.getElementById("center-pane").removeEventListener("mousemove",K),t()):"resize"===r&&(document.getElementById("center-pane").removeEventListener("mouseup",I),document.getElementById("center-pane").removeEventListener("mousemove",K),i())};var Ie=!1,Ke=[],We=[],ke=[],Ue=[],Xe=0,Ye=0,_e=0,Ze=2*Math.PI}(a||(a={})),t.default=a});