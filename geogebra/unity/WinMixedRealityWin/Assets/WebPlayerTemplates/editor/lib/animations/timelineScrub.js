define(["require","exports","../function_helpers","scripts/helpers/units_conversion","../enums","../../scripts/main"],function(e,t,r,i,a,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(e){this.currentKeyframeStack={},this.previousKeyframeStack={},this.runtimeEditor=e}return e.prototype.returnKeyframeValues=function(e){var t=$.extend(!0,{},e),r=parseFloat(Object.keys(t)[0]);return"number"!=typeof r||isNaN(r)?(t=t[Object.keys(t)[0]],this.returnKeyframeValues(t)):t},e.prototype.findKeyFramesBetweenTime=function(e,t,r){var i,a=[];for(i in r)((i=parseFloat(i))>=e&&i<=t||i<=e&&i>=t)&&i!==e&&a.push(i);return t<e&&a.reverse(),a},e.prototype.renderKeyframesInTime=function(e,t){if(e!==t){var i=[],a="";if(!this.runtimeEditor.iframe){var o=this.runtimeEditor.scene.animations;for(var l in o){var s=o[l].id;for(var n in o[l])for(var u in o[l][n].keyframes){a=u;for(var p in o[l][n].keyframes[u])i=i.concat(this.findKeyFramesBetweenTime(e,t,o[l][n].keyframes[u][p]))}i.push(t),i=r.default.removeDuplicates(i),e>t?i.sort(function(e,t){return t-e}):i.sort(function(e,t){return e-t});for(var d=0;d<i.length;d++)this.currentKeyframeStack[s]={},this.performTimelineScrub(s,i[d]),this.executeStackedStyleChanges(a)}}}},e.prototype.executeStackedStyleChanges=function(e){for(var t in this.currentKeyframeStack){var r=document.getElementById(t);for(var i in this.currentKeyframeStack[t])r.style[i]=this.currentKeyframeStack[t][i]}this.previousKeyframeStack=$.extend(!0,{},this.currentKeyframeStack),this.currentKeyframeStack={}},e.prototype.updateStackedStyleChanges=function(e,t){var r="rotate"===e.styleType?"transform":e.styleType;void 0!==this.previousKeyframeStack[e.id]&&this.previousKeyframeStack[e.id][r]===e.newValue||(void 0===this.currentKeyframeStack[e.id]&&(this.currentKeyframeStack[e.id]={}),this.currentKeyframeStack[e.id][r]||(this.currentKeyframeStack[e.id][r]=""),"-webkit-filter"===e.propGroup?"dropShadowBlur"!==t&&"dropShadowX"!==t&&"dropShadowY"!==t&&"dropShadowColor"!==t&&(this.currentKeyframeStack[e.id][r]+=t+"("+e.newValue.trim()+")"):this.currentKeyframeStack[e.id][r]=e.newValue)},e.prototype.adjustBackgroundSize=function(e,t,a,o){var l,s,n=e.split(" "),u=t.split(" "),p=parseFloat(i.default.convertUnitsToPixel(o,n[0],"backgroundSize")),d=parseFloat(i.default.convertUnitsToPixel(o,n[1],"backgroundSize")),y=p+(parseFloat(i.default.convertUnitsToPixel(o,u[0],"backgroundSize"))-p)/100*a,f=d+(parseFloat(i.default.convertUnitsToPixel(o,u[1],"backgroundSize"))-d)/100*a;return a<50?(l=r.default.getUnitStyle(n[0]),s=r.default.getUnitStyle(n[1])):(l=r.default.getUnitStyle(u[0]),s=r.default.getUnitStyle(u[1])),{appliedValue:y+"px "+f+"px",displayedValue:i.default.convertPixelToUnit(o,y,l,"backgroundSize")+" "+i.default.convertPixelToUnit(o,f,s,"backgroundSize")}},e.prototype.adjustBoxShadowInset=function(e,t,r,i){var a=e.split(" "),o=t.split(" "),l=r.split(" ");return l[0]=i<50?"remove"!==a[0]?a[0]:o[0]:"remove"!==o[0]?o[0]:a[0],l.join(" ").replace("remove","").trim()},e.prototype.modulateStyleValue=function(e,t,r,i,a){for(var o=[],l=0;l<t.length;l++){var s=parseFloat(t[l]),n=parseFloat(r[l]);o[l]=s+(n-s)/100*i}var u=0;return e.map(function(e){if(isNaN(parseInt(e))&&0!==e.indexOf("#"))return e;switch(a){case"backgroundSize":case"-webkit-mask-size":case"boxShadowProperties":case"filterProperties":case"borderColor":case"backgroundColor":return o[u++].toFixed(2);case"transform":case"transform-origin":case"perspective-origin":return o[u++].toFixed(1);case"color":return 3===u?o[u++].toFixed(2):o[u++].toFixed(0);case"-webkit-mask-position-x":case"-webkit-mask-position-y":case"borderWidth":case"borderTopLeftRadius":case"borderTopRightRadius":case"borderBottomLeftRadius":case"borderBottomRightRadius":case"backgroundPositionX":case"backgroundPositionY":case"opacity":case"left":case"top":case"width":case"height":case"scaleX":case"scaleY":case"scaleZ":return o[0].toFixed(2);case"rotate":case"fontSize":case"rotateX":case"rotateY":case"rotateZ":case"translateX":case"translateY":case"translateZ":case"skewX":case"skewY":case"perspective":return o[0].toFixed(1);case"zIndex":return o[0].toFixed(0)}}).join("")},e.prototype.adjustForStringStylesValues=function(e){var t=/([-|+|#]?\d*\.?\d+)/g,a=e.percentageShift>50,o=e.lowerKeyframeValue.match(t),l=e.higherKeyframeValue.match(t);if(null===o||null===l||"fontWeight"===e.styleType||"fontStyle"===e.styleType)e.newValue=a?e.higherKeyframeValue:e.lowerKeyframeValue,e.originalValue=e.newValue;else if("-webkit-filter"===e.propGroup){var s=/\((.*?)\)/,n=e.lowerKeyframeValue.match(s);null!==n&&(e.originalValue=n[1]);u=e.lowerKeyframeValue.split(t);e.newValue=this.modulateStyleValue(u,o,l,e.percentageShift,e.styleType)}else{var u=e.lowerKeyframeValue.split(t);e.newValue=this.modulateStyleValue(u,o,l,e.percentageShift,e.styleType),""!==e.lowerKeyframeStyle.trim()&&""!==e.higherKeyframeStyle.trim()&&"transform"!==e.propGroup&&"transform-origin"!==e.propGroup&&"perspective-origin"!==e.styleType?a&&!r.default.isBackgroundPositionString(e.originalValue)?e.originalValue=i.default.convertPixelToUnit(e.id,e.newValue,e.higherKeyframeStyle,e.styleType):r.default.isBackgroundPositionString(e.originalValue)||(e.originalValue=i.default.convertPixelToUnit(e.id,e.newValue,e.lowerKeyframeStyle,e.styleType)):e.originalValue=e.newValue}return e},e.prototype.adjustForBackgroundPosition=function(e){var t=e.percentageShift>50;return"backgroundPositionX"!==e.styleType&&"backgroundPositionY"!==e.styleType&&"-webkit-mask-position-y"!==e.styleType&&"-webkit-mask-position-x"!==e.styleType||(e.originalValue=t?e.higherKeyframeValue:e.lowerKeyframeValue,"center"===e.lowerKeyframeValue||"bottom"===e.lowerKeyframeValue||"right"===e.lowerKeyframeValue?e.lowerKeyframeValue=this.runtimeEditor._fixBackgroundPercentage(e.lowerKeyframeValue,e.id,e.styleType):e.lowerKeyframeValue=r.default.getStringPropertyPercent(e.lowerKeyframeValue),"center"===e.higherKeyframeValue||"bottom"===e.higherKeyframeValue||"right"===e.higherKeyframeValue?e.higherKeyframeValue=this.runtimeEditor._fixBackgroundPercentage(e.higherKeyframeValue,e.id,e.styleType):e.higherKeyframeValue=r.default.getStringPropertyPercent(e.higherKeyframeValue)),e},e.prototype.adjustGroupedStyles=function(e,t){var a=!1;if(1===this.runtimeEditor.currentElementsSelection.length&&this.runtimeEditor.currentElementsSelection[0]===e.id&&(a=!0),a&&"transform-origin"!==e.styleType&&"perspective-origin"!==e.styleType&&!r.default.isTransformProperty(e.styleType)&&"-webkit-mask-size"!==e.styleType&&"filterProperties"!==e.styleType){var o=r.default.shortenLongValue(e.originalValue);this.runtimeEditor.setPropertiesBarValue(e.id,e.propGroup,e.styleType,o)}if("left"===e.styleType||"top"===e.styleType||"width"===e.styleType||"height"===e.styleType||"fontSize"===e.styleType){var l=r.default.getUnitStyle(e.newValue);"px"!==l&&"%"!==l&&(e.newValue=i.default.convertUnitsToPixel(e.id,e.newValue))}else if("filterProperties"===e.styleType)e.styleType="-webkit-filter",a&&this.runtimeEditor.setFilterInput(e.styleType,t,e.newValue);else if("boxShadowProperties"===e.styleType){if(e.styleType="boxShadow",e.newValue=this.adjustBoxShadowInset(e.lowerKeyframeValue,e.higherKeyframeValue,e.newValue,e.percentageShift),a)for(var s=r.default.getValuesBoxshadow(e.newValue),n=0;n<s.length-1;n+=2)this.runtimeEditor.setBoxShadowInput(e.styleType,s[n],s[n+1])}else if("rotate"===e.styleType)e.originalValue=e.newValue,e.newValue="rotate("+e.newValue+")";else if("backgroundSize"===e.styleType){var u=this.adjustBackgroundSize(e.lowerKeyframeValue,e.higherKeyframeValue,e.percentageShift,e.id);e.newValue=u.appliedValue,a&&this.runtimeEditor.selectKendoDropdownItem("styles","backgroundSize",u.displayedValue)}else if("-webkit-mask-size"===e.styleType){var p=e.newValue.split(" ");p.length>1?(this.runtimeEditor.setPropertiesBarValue(e.id,e.propGroup,"-webkit-mask-sizeWidth",p[0]),this.runtimeEditor.setPropertiesBarValue(e.id,e.propGroup,"-webkit-mask-sizeHeight",p[1])):this.runtimeEditor.selectKendoDropdownItem("styles",e.styleType,e.newValue)}else(r.default.isTransformProperty(e.styleType)||"transform-origin"===e.styleType||"perspective-origin"===e.styleType)&&(e=this.adjustTransformStyles(e));return e},e.prototype.adjustTransformStyles=function(e){e.originalValue="edited_transform";var t,i,a={};r.default.isTransformProperty(e.styleType)?(t=[e.styleType],a[e.styleType]=[e.newValue]):"perspective-origin"===e.styleType?(t=["perspective-origin-x","perspective-origin-y"],a={"perspective-origin-x":(i=e.newValue.split(" "))[0],"perspective-origin-y":i[1]}):(t=["transform-origin-x","transform-origin-y"],a={"transform-origin-x":(i=e.newValue.split(" "))[0],"transform-origin-y":i[1]});for(var o=0;o<t.length;o++){var l=t[o],s=a[l],n=this.runtimeEditor.mappedWidgets[e.id].widget;"transform-origin"===e.propGroup?this.runtimeEditor._setTransformOrigin(null,n,n.id,e.propGroup,l,s[0]):"perspective-origin"===e.styleType?this.runtimeEditor._setStyles(null,n,n.id,e.propGroup,l,s[0]):this.runtimeEditor._setTransform(null,n,n.id,e.propGroup,e.styleType,s[0])}return e},e.prototype.adjustForUnitConversion=function(e){var t=["pt","rem","vh","vw","vmax","vmin","%"];return-1!==t.indexOf(e.lowerKeyframeStyle)&&"backgroundSize"!==e.styleType&&"-webkit-mask-size"!==e.styleType&&"transform-origin"!==e.styleType&&"perspective-origin"!==e.styleType&&(e.lowerKeyframeValue=i.default.convertUnitsToPixel(e.id,e.lowerKeyframeValue,e.styleType)),-1!==t.indexOf(e.higherKeyframeStyle)&&"backgroundSize"!==e.styleType&&"-webkit-mask-size"!==e.styleType&&"transform-origin"!==e.styleType&&"perspective-origin"!==e.styleType&&(e.higherKeyframeValue=i.default.convertUnitsToPixel(e.id,e.higherKeyframeValue,e.styleType)),e},e.prototype.adjustForFilterValues=function(e,t,i){return e.lowerKeyframeValue=r.default.buildFilterProps(t[i.lower],!1),e.higherKeyframeValue=r.default.buildFilterProps(t[i.higher],!1),e},e.prototype.performTimelineScrub=function(e,t,i,l,s){void 0===l&&(l=!1);var n,u=[];if(i)n=this.runtimeEditor.scene.animationClasses[i];else{var p=this.runtimeEditor.scene.animations[e];if(!p)return;if(!(n=this.runtimeEditor.scene.animations[e][p.className]))return}var d=n.keyframes,y=Object.keys(d);null===e&&(y=[s]);for(var f=0;f<y.length;f++){var m=d[y[f]],c=Object.keys(m).length,h=!1,g=void 0,w={id:e,styleType:"",newValue:"",propGroup:"",originalValue:"",lowerKeyframeValue:"",lowerKeyframeStyle:"",higherKeyframeValue:"",higherKeyframeStyle:"",percentageShift:0};(m.dropShadowX||m.dropShadowY||m.dropShadowColor||m.dropShadowBlur)&&(h=!0);for(var S=0;S<c;S++){var V={};V[Object.keys(m)[S]]=m[Object.keys(m)[S]];var v=this.returnKeyframeValues(V),k=Object.keys(v).map(function(e){return parseFloat(e)}),T=void 0,K=void 0;if(-1!==k.indexOf(t)?T=K=t:(T=r.default.biggerClosest(k,t),K=r.default.smallerClosest(k,t)),l||K<=t&&T>=t||"-webkit-filter"===v[K].group){w.percentageShift=(t-K)/(T-K)*100,w.percentageShift=isFinite(w.percentageShift)?w.percentageShift:100,w.propGroup=v[K].group,w.styleType=v[K].property,g=w.styleType,w.lowerKeyframeValue=v[K].values[0],w.higherKeyframeValue=v[T].values[0];var b=a.default["-webkit-filterDefaultValues"][w.styleType];"-webkit-filter"===w.propGroup&&"undefined"!==b&&(w.styleType="filterProperties",w=this.adjustForFilterValues(w,v,{lower:K,higher:T})),w.lowerKeyframeValue=r.default.convertColorValues(w.lowerKeyframeValue),w.higherKeyframeValue=r.default.convertColorValues(w.higherKeyframeValue),(w=this.adjustForBackgroundPosition(w)).lowerKeyframeStyle=r.default.getUnitStyle(w.lowerKeyframeValue),w.higherKeyframeStyle=r.default.getUnitStyle(w.higherKeyframeValue),w=this.adjustForUnitConversion(w),(w=this.adjustForStringStylesValues(w)).newValue=r.default.stylesValueNormalizer(w.newValue),w.originalValue=r.default.stylesValueNormalizer(w.originalValue),"-webkit-filter"===w.propGroup&&r.default.buildDropShadowFiltersProps(v[K],w.newValue),null!==e&&(w=this.adjustGroupedStyles(w,g)),"edited_transform"!==w.originalValue&&null!==e&&this.updateStackedStyleChanges(w,v[T].property),l?("dropShadowX"!==g&&"dropShadowY"!==g&&"dropShadowColor"!==g&&"dropShadowBlur"!==g&&u.push({key:g,value:w.newValue}),S+1===c&&h&&(u.push({key:"dropShadow",value:r.default.buildDropShadowProperty(this.runtimeEditor.runtimeBuildDropShodowFilter)}),this.runtimeEditor.runtimeBuildDropShodowFilter=r.default.getBoxShodowDefaults())):this.applyStyleToWidget(w,g)}}if("-webkit-filter"===w.styleType&&!l&&h){var x=o.default.openFiles[o.default.selectedEditor].runtimeEditor,E=r.default.buildDropShadowProperty(x.runtimeBuildDropShodowFilter);this.currentKeyframeStack[e][w.styleType]+=E,this.runtimeEditor.runtimeBuildDropShodowFilter=r.default.getBoxShodowDefaults()}}if(l)return u},e.prototype.applyStyleToWidget=function(e,t){var i=this;if(null!==e.id){var a=r.default.shortenLongValue(e.originalValue);if("backgroundColor"===e.propGroup)this.runtimeEditor.mappedWidgets[e.id].widget.background=a;else if("-webkit-mask-size"===e.styleType){var o=e.newValue.split(" ");o.length>1?(this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup]["-webkit-mask-size"]="auto",this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup]["-webkit-mask-sizeWidth"]=o[0],this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup]["-webkit-mask-sizeHeight"]=o[1]):this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][e.styleType]=a}else if("fontSize"===e.styleType)this.runtimeEditor.mappedWidgets[e.id].widget.fontSize=a;else if("color"===e.styleType)this.runtimeEditor.mappedWidgets[e.id].widget.color=a;else if("transform-origin"===e.styleType){var l=e.newValue.split(" ");this.runtimeEditor.mappedWidgets[e.id].widget["transform-origin"]["transform-origin-x"]=l[0],this.runtimeEditor.mappedWidgets[e.id].widget["transform-origin"]["transform-origin-y"]=l[1]}else if("perspective-origin"===e.styleType){var s=e.newValue.split(" ");this.runtimeEditor.mappedWidgets[e.id].widget["perspective-origin"]["perspective-origin-x"]=s[0],this.runtimeEditor.mappedWidgets[e.id].widget["perspective-origin"]["perspective-origin-y"]=s[1]}else if(r.default.isTransformProperty(e.styleType))this.runtimeEditor.mappedWidgets[e.id].widget.transform[e.styleType]=e.newValue;else if("-webkit-filter"===e.styleType){var n=r.default.getWebkitFilterObject(e.newValue);0!==Object.keys(n).length?Object.keys(n).map(function(t){i.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][t]=n[t]}):this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][t]=e.newValue}else if("boxShadow"===e.styleType){var u=r.default.getBoxshadowObject(e.newValue);Object.keys(u).map(function(t){i.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][t]=u[t]})}else this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][e.styleType]=a}},e}();t.TimelineScrub=l});