define(["require","exports","../enums","../function_helpers","../../scripts/main","./timelineScrub"],function(e,t,i,a,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e){this.currentKeyframeStack={},this.previousKeyframeStack={},this.runtimeEditor=e,this.templateKeyframeLine=document.getElementById("keyframe-line"),this.templateKeyframePropName=document.getElementById("keyframe-property-name"),this.templateKeyframe=document.getElementById("keyframe-html")}return e.prototype.init=function(){this.Timeline=this.runtimeEditor.Timeline,this.TimelineScrub=new n.TimelineScrub(this.runtimeEditor)},e.prototype.widgetKeyframesHandlers=function(e){var t=this;$(e).find(".add-keyframe").off("click"),$(e).find(".add-keyframe").on("click",function(){t.runtimeEditor._sceneActionState.primaryAction="new action",t.collectKeyframeData($(this))})},e.prototype.onKeyframeChange=function(e,t,i){var r=e[0].attributes["data-keyframe-widget-id"].value,n=e[0].attributes["data-animation-class"].value,o=e[0].attributes["data-keyframe-property"].value,s=e[0].attributes["data-keyframe-group"].value,m=this.runtimeEditor.scene.animationClasses[n].keyframes[s][o],d=parseFloat(e[0].attributes["data-current-time"].value),l=a.default.getFromTimeline('[data-widget-id="'+r+'"] [data-property-type="'+o+'"][data-keyframe-group="'+s+'"]  [data-current-time="'+i+'"]');d!==i&&(m.renameProperty(t,i),m[i].time.seconds=i,l.length>0&&l.remove());var f=this.runtimeEditor.getRedoUndoPrimaryState();if("new action"!==f){var u=this.Timeline.convertTimeToOffsetX(i);e[0].style.left=u+"px",e[0].attributes["data-current-time"].value=i}var p={oldTime:t,currentTime:i};this.runtimeEditor._sceneActionState.moveKeyframe=!0,this.runtimeEditor.createUndoRedoCommand(f,r,s,s,o,p)},e.prototype.getValue=function(e,t,i){var a=e.parents(".wrap-property"),r=this.runtimeEditor.getSelectedWidgetId(),n=this.runtimeEditor.mappedWidgets[r].widget;switch(t){case"geometry":return this.runtimeEditor.getGeometryValue(a,t,i);case"transform-origin":return this.runtimeEditor.getTransformOriginValue(a,t,i);case"transform":return this.runtimeEditor.getTransformValue(a,t,i);case"-webkit-filter":return this.runtimeEditor.getFilterValues(n,t,i);case"boxShadow":return this.runtimeEditor.buildBoxShadowProperty(n);case"backgroundColor":return this.runtimeEditor.getBackgroundColorValue();case"styles":return this.runtimeEditor.getStyleValue(a,t,i);case"font":return this.runtimeEditor.getFontValue(a,t,i)}},e.prototype.collectKeyframeData=function(e){var t,r=this.runtimeEditor.getSelectedWidgetId(),n=this.Timeline.getPinTime(),o=e.attr("data-property-key"),s=e.attr("data-property-set");if("transform-origin"===o){var m=a.default.getFromTimeline('[data-property-set="transform-origin"][data-property-key="transform-origin-x"]'),d=a.default.getFromTimeline('[data-property-set="transform-origin"][data-property-key="transform-origin-y"]');t=this.getValue(m,s,"transform-origin-x")+" "+this.getValue(d,s,"transform-origin-y")}else if("perspective-origin"===o){var l=a.default.getFromTimeline('[data-property-set="styles"][data-property-key="perspective-origin-x"]'),f=a.default.getFromTimeline('[data-property-set="styles"][data-property-key="perspective-origin-y"]');t=this.getValue(l,s,"perspective-origin-x")+" "+this.getValue(f,s,"perspective-origin-y")}else t=this.getValue(e,s,o);"-webkit-filter"===s&&(o=i.default.StylePropToKeyframeProp[s][o]),a.default.notAllowedForAnimation(o,t)||(this.runtimeEditor.Animations.addKeyframe(r,s,o,t,n),"transform"===s&&a.default.syncTransformAnimations(r,o),"-webkit-filter"===s&&a.default.syncFiltersAnimations(r,o))},e.prototype.addKeyframe=function(e,t,i,n,o){var s=this.runtimeEditor,m=s.mappedWidgets[e].widget,d=s.mappedWidgets[e].widget.className||"";""!==d&&(d=a.default.getAnimationClassNames(d));var l=a.default.getFromTimeline('[data-keyframe-widget-id="'+e+'"][data-keyframe-property="'+i+'"][data-keyframe-group="'+t+'"][data-current-time="'+o.seconds+'"]');if(1===l.length){var f=this.Timeline.getKeyframeWidgetData(l);if(f.className===d&&f.prop===i&&f.value===n)return}if(s._sceneActionState.keyframeInitial)this.setKeyframe(e,t,i,n,o,d);else{var u=a.default.getFromTimeline('[data-timeline-info-widget-id="'+e+'"] .info-property-name'),p={positions:$.extend(!0,{},o),value:n},c=s.getRedoUndoPrimaryState();if(l.length>0&&(p.oldKeyframe=s.scene.animations[e][d].keyframes[t][i][o.seconds]),0===u.length&&"new action"===c){var y=!1;""===d&&(r.default.preferences.timeline.filterTimelineWidgets&&s.Timeline.addWidget(m,{initial:!1}),d=r.default.generateClassName(),y=!0),p.className=d;var g=$(this).parents(".info-class-name").find(".animation-class-name-input").val()||"";s._sceneActionState.switchAnimationClass=!0,this.Timeline.initAnimationClassName(e,g,d),this.setKeyframe(e,t,i,n,o,d);var h=0,v=[];for(var T in s.scene.animations)T!==e&&s.scene.animations[T].className===d&&(h++,this.setKeyframe(T,t,i,n,o,d),v.push(T));for(var k=0;k<h;k++)s._sceneActionState.addKeyframe=!0,s.createUndoRedoCommand(c,v[k],t,t,i,p);y&&s.autoKeyframe&&"new action"===s._sceneActionState.primaryAction&&(s._sceneActionState.addKeyframe=!0,s._undoCreationStepsLength+=1,s.createUndoRedoCommand(c,e,t,t,i,p))}else if("new action"!==c){0===u.length&&(s.Animations.createAnimationWidget(m,{initial:!1}),this.Timeline.initAnimationClassName(e,"",d,!1,!0),a.default.getFromTimeline('[data-timeline-info-widget-id="'+e+'"] .animation-class-name-input').show()),this.setKeyframe(e,t,i,n,o,d);for(var T in s.scene.animations)T!==e&&s.scene.animations[T].className===d&&this.setKeyframe(T,t,i,n,o,d);p.className=d,s._sceneActionState.addKeyframe=!0,s.createUndoRedoCommand(c,e,t,t,i,p)}else{var h=0,v=[];for(var T in s.scene.animations)s.scene.animations[T][d]&&(h++,s.autoKeyframe||s.forceAutoKeyframes||(s._undoCreationStepsLength=h),this.setKeyframe(T,t,i,n,o,d),v.push(T));p.className=d;for(var w=0;w<h;w++)s._sceneActionState.addKeyframe=!0,s.createUndoRedoCommand(c,v[w],t,t,i,p)}}a.default.getFromTimeline(".info-widgets").getNiceScroll().resize()},e.prototype.buildKeyframeObject=function(e,t,a,r,n){var o=this.runtimeEditor.mappedWidgets[e].widget.className.split(" "),s=this.runtimeEditor.scene.animations,m=this.runtimeEditor.scene.animationClasses;return o.filter(function(o){m[o]&&(m[o]=m[o]||$.extend(!0,{},i.default.newAnimation),m[o].className=o,m[o].keyframes[t]=m[o].keyframes[t]||{},m[o].animationsData[t]=m[o].animationsData[t]||{},m[o].animationsData[t][a]=m[o].animationsData[t][a]||{timing:"linear",direction:"normal",iteration:1,name:o+"_"+t+"_"+a},m[o].keyframes[t][a]=m[o].keyframes[t][a]||{},m[o].keyframes[t][a][n.seconds]={property:a,group:t,values:[r],time:n},s[e]=s[e]||{},s[e][o]||(s[e][o]=m[o]),s[e].id=e,s[e].className=o)}),s},e.prototype.setKeyframe=function(e,t,i,n,o,s){var m=this.buildKeyframeObject(e,t,i,n,o),d=a.default.getFromTimeline('[data-keyframe-widget-id="'+e+'"][data-keyframe-property="'+i+'"][data-keyframe-group="'+t+'"][data-current-time="'+o.seconds+'"]');d.length>0&&d.remove();var l=r.default.importHtmlTemplate(this.templateKeyframeLine);if(l.setAttribute("data-property-type",i),a.default.getFromTimeline('[data-widget-id="'+e+'"] [data-property-type="'+i+'"]').length<=0){var f=a.default.getFromTimeline('[data-timeline-info-widget-id="'+e+'"]'),u=r.default.importHtmlTemplate(this.templateKeyframePropName);u.setAttribute("data-timeline-info-property-name",i),$(u).addClass(s),$(u).find(".property-name-text").text(i);var p=u.querySelectorAll(".ic-properties");f.append(u),a.default.getFromTimeline('.widgets-keyframes [data-widget-id="'+e+'"]').append(l),this.Timeline.createTooltip(a.default.getFromTimeline(p),m[e],t,i)}var c=r.default.importHtmlTemplate(this.templateKeyframe);c.classList.add("keyframe","dragging-point"),c.setAttribute("data-current-time",o.seconds),c.setAttribute("data-keyframe-group",t),c.setAttribute("data-keyframe-property",i),c.setAttribute("data-keyframe-widget-id",e),c.setAttribute("data-animation-class",s);var y=this.Timeline.convertTimeToOffsetX(o.seconds);c.style.left=y+"px";var g=a.default.getFromTimeline('[data-widget-id="'+e+'"] [data-property-type="'+i+'"]');g.append(c),g.addClass(s),c.offsetLeft>$("#timeline-ruler").width()&&(this.Timeline.originalRulerWidth=c.offsetLeft+200)},e}();t.default=o});