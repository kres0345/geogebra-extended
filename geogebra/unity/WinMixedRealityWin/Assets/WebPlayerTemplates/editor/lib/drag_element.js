define(["require","exports","./function_helpers","../scripts/main","./transform"],function(t,e,o,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n;!function(t){function e(t,e,o){"string"==typeof t&&(t=document.getElementById(t)),null!==t&&t.addEventListener(e,o,!1)}function n(t,e,o){"string"==typeof t&&(t=document.getElementById(t)),null!==t&&t.removeEventListener(e,o,!1)}function i(t){return(t=t||window.event).stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.cancel=!0,t.returnValue=!1,!1}function r(){B=!1,T=!1;for(var t,e,l=[],n=0;n<w;n++){if(null!==F[n]&&(y[n].offsetTop,y[n].offsetLeft),t=(window.mouseCoordsX-m)/g,e=(window.mouseCoordsY-c)/g,null!==F[n]){var i=o.default.getElementAbsoluteTransformV2(E[n]),r=o.default.getTransformedCoordsGlobal(t,e,m,c,i);l.push(r)}else l.push(null)}for(var d=0;d<w;d++){for(var p=E[d].id,f=!0,h=!0;"scene"!==p&&-1!==M.indexOf(p);){var v=$("#"+p);f="auto"!==E[d].style.left&&""!==E[d].style.left,h="auto"!==E[d].style.top&&""!==E[d].style.top,p=v[0].parentElement.id}f&&!B&&null!==F[d]&&null!==l[d]&&(E[d].style.left=b[d]+l[d].x+"px"),h&&!T&&null!==F[d]&&null!==l[d]&&(E[d].style.top=V[d]+l[d].y+"px")}for(var x=0;x<w;x++){var C=y[x].attributes["data-widget-id"].nodeValue,D=a.default.selectedEditor,L=a.default.openFiles[D].runtimeEditor.mappedWidgets[C].widget;if(L.transformed_position){W.transform(L);var I=o.default.getTransformedElMaskPos(L);y[x].style.width=I.width+"px",y[x].style.height=I.height+"px",y[x].style.top=I.top+"px",y[x].style.left=I.left+"px"}}if(a.default.openFiles[a.default.selectedEditor].tab.snapOn&&0!==P.length){for(var O=u(E,!0)[0],k=0;k<P.length;k++){var H=P[k],S={dragValue:O.top,stationaryValue:H.top,styleValueDrag:"top",elementBounds:O,snapBox:H};s(S),S.stationaryValue=H.top+H.height,s(S),S.styleValueDrag="bottom",S.stationaryValue=H.top-O.height,s(S),S.stationaryValue=H.top+H.height-O.height,s(S),S.dragValue=O.left,S.stationaryValue=H.left,S.styleValueDrag="left",s(S),S.stationaryValue=H.left+H.width,s(S),S.styleValueDrag="right",S.stationaryValue=H.left-O.width,s(S),S.stationaryValue=H.left+H.width-O.width,s(S)}B||$("#snap-line-horizontal").css({display:"none"}),T||$("#snap-line-vertical").css({display:"none"})}}function s(t){var e=t.stationaryValue,o=t.dragValue,a=t.styleValueDrag;if(o>e-5&&o<e+5){if("left"===a||"right"===a){if(T)return}else if(B)return;p(t),d(t)}}function d(t){var e=t.styleValueDrag,o=t.snapBox,a=t.elementBounds,l=t.stationaryValue;if("top"===e||"bottom"===e){l="top"===e?l:l+a.height;var n=Math.min(o.left+o.width/2,a.left+a.width/2),i=Math.abs(n-Math.max(o.left+o.width/2,a.left+a.width/2));$("#snap-line-horizontal").css({display:"block",left:n+"px",top:l+"px",width:i+"px"}),B=!0}else{l="left"===e?l:l+a.width;var r=Math.min(o.top+o.height/2,a.top+a.height/2),s=Math.abs(r-Math.max(o.top+o.height/2,a.top+a.height/2));$("#snap-line-vertical").css({display:"block",left:l+"px",top:r+"px",height:s+"px"}),T=!0}}function u(t,e){for(var l=[],n=a.default.openFiles[a.default.selectedEditor].runtimeEditor,i=0;i<t.length;i++){var r=$("#"+t[i].id),s=r[0],d=$("#scene"),u=n.getWidgetBoundingRect(s),p=n.getWidgetBoundingRect(d[0]),f=o.default.rotationInfo(s);p.left=p.left+parseFloat(d.css("border-left-width")),p.top=p.top+parseFloat(d.css("border-top-width"));var h={width:u.right-u.left,height:u.bottom-u.top,left:u.left-p.left,top:u.top-p.top},g=getComputedStyle(s,null),m={left:parseFloat(g.getPropertyValue("border-left-width"))+parseFloat(g.getPropertyValue("margin-left")),right:parseFloat(g.getPropertyValue("border-right-width"))+parseFloat(g.getPropertyValue("margin-right")),top:parseFloat(g.getPropertyValue("border-top-width"))+parseFloat(g.getPropertyValue("margin-top")),bottom:parseFloat(g.getPropertyValue("border-bottom-width"))+parseFloat(g.getPropertyValue("margin-bottom"))},c=m.left+m.right,y=m.top+m.bottom,w=r.width()+c+parseFloat(g.getPropertyValue("padding-right"))+parseFloat(g.getPropertyValue("padding-left")),v=r.height()+y+parseFloat(g.getPropertyValue("padding-top"))+parseFloat(g.getPropertyValue("padding-bottom")),x=f.deg*Math.PI/180,b=Math.sin(x),V=Math.cos(x),M=V*w,E=b*w,F=-b*v,P=V*v,B=V*w-b*v,T=b*w+V*v,W=Math.min(0,M,F,B),D=Math.max(0,M,F,B),L=Math.min(0,E,P,T),I=Math.max(0,E,P,T);h.deltaWidth=(D-W-w)/2,h.deltaHeight=(I-L-v)/2,"scene"!==s.parentElement.id?h.isChild=!0:h.isChild=!1,l.push(h)}if(C=l,e&&C.length>1){for(var O={left:[],top:[],right:[],bottom:[],deltaWidth:[],deltaHeight:[]},k=0;k<l.length;k++)O.left.push(l[k].left),O.top.push(l[k].top),O.right.push(l[k].left+l[k].width),O.bottom.push(l[k].top+l[k].height),O.deltaWidth.push(l[k].deltaWidth),O.deltaHeight.push(l[k].deltaHeight);return O.left=Math.min.apply(Math,O.left),O.top=Math.min.apply(Math,O.top),O.width=Math.max.apply(Math,O.right)-O.left,O.height=Math.max.apply(Math,O.bottom)-O.top,O.deltaWidth=Math.max.apply(Math,O.deltaWidth),O.deltaHeight=Math.max.apply(Math,O.deltaHeight),delete O.right,delete O.bottom,[O]}return l}function p(t){var e,a,l=t.styleValueDrag,n=t.stationaryValue;"left"===l||"right"===l?(l="left",e="deltaWidth"):(l="top",e="deltaHeight");for(var i=t.elementBounds[l],r=0;r<E.length;r++)if(a=n+C[r][e]+C[r][l]-i,C[r].isChild&&-1===M.indexOf(E[r].parentElement.id)){var s=parseFloat(E[r].style.top),d=parseFloat(E[r].style.left),u=o.default.rotationInfo(E[r].parentElement,"single"),p=o.default.getAbsolutePosition(E[r],"scene"),f=o.default.getTransformedCoordsRotation(p.left,p.top,u.rad);p[l]=p[l]-(i-n);var h=o.default.getTransformedCoordsRotation(p.left,p.top,u.rad);E[r].style.top=s+h.y-f.y+"px",E[r].style.left=d+h.x-f.x+"px",y[r].style[l]=parseFloat(y[r].style[l])-(i-n)+"px"}else if(!C[r].isChild){var g=parseFloat(E[r].style[l]);E[r].style[l]=a+"px",y[r].style[l]=parseFloat(y[r].style[l])-(g-a)+"px"}}var f,h,g,m,c,y,w,v=[],x=[],b=[],V=[],M=[],E=[],F=[],P=[],C=[],B=!1,T=!1,W=new l.default;t.dragObject=function(t,o,l,s,d,p,W,D,L){function I(t){var o=a.default.openFiles[a.default.selectedEditor],l=o.runtimeEditor.isInPanningMode;if(o.runtimeEditor.inputSearch.focusout(),!R&&_&&!A){if(!l){if(R=!0,null!==p&&p(),f=$("#scene")[0],h=new WebKitCSSMatrix(window.getComputedStyle(f).webkitTransform),g=h.a,m=window.mouseCoordsX,c=window.mouseCoordsY,y=document.getElementsByTagName("mask"),w=y.length,F=o.runtimeEditor.currentParentElementsSelection,M=o.runtimeEditor.currentElementsSelection,a.default.openFiles[a.default.selectedEditor].tab.snapOn){var n=o.runtimeEditor.mappedWidgets,s=$.map(n,function(t){if(-1===M.indexOf(t.widget.id))return t.widget}),d=M.map(function(t){if(n[t].widget.children.length>0)return n[t].widget.children.map(function(t){return t.id})});d=[].concat.apply([],d),s=s.filter(function(t){return-1===d.indexOf(t.id)}),P=u(s),$("<div/>",{id:"snap-line-horizontal"}).css({"background-color":"#d973d9","border-radius":"10px",position:"absolute",height:1/g+"px",display:"none"}).appendTo("#scene"),$("<div/>",{id:"snap-line-vertical"}).css({"background-color":"#d973d9","border-radius":"10px",position:"absolute",width:1/g+"px",display:"none"}).appendTo("#scene")}for(var C=0;C<w;C++)E[C]=document.getElementById(M[C]),v[C]=y[C].offsetTop,x[C]=y[C].offsetLeft,null!==F[C]&&(V[C]=E[C].offsetTop,b[C]=E[C].offsetLeft);return r(),e(document,"mousemove",O),e(document,"mouseup",k),i(t)}H()}}function O(t){if(!A&&!t.altKey)return r(),null!==W&&W(),i(event)}function k(t){return H(),i(t)}function H(){R&&!A&&($("#snap-line-horizontal").remove(),$("#snap-line-vertical").remove(),C=[],B=!1,T=!1,n(document,"mousemove",O),n(document,"mouseup",k),z=null,null!==D&&D(t),R=!1)}if(E=new Array(o),null!==s&&null!==d){var S=s.Min(d);d=s.Max(d),s=S}var z=null,R=!1,_=!1,A=!1;window.dispose=function(){A||(window.stopListening(!0),t=null,l=null,s=null,d=null,p=null,W=null,D=null,A=!0)},window.startListening=function(){_||A||(_=!0,e(l,"mousedown",I))},window.stopListening=function(t){_&&!A&&(n(l,"mousedown",I),_=!1,t&&R&&H())},window.isDragging=function(){return R},window.isListening=function(){return _},window.isDisposed=function(){return A},"string"==typeof l&&(l=document.getElementById(l)),null===l&&(l=t),L||window.startListening()}}(n||(n={})),e.default=n});