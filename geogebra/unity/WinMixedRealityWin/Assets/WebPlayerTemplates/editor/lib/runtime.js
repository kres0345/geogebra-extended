define(["require","exports","./enums","../scripts/main","./function_helpers","./enums","../scripts/globals/globals","./editor_settings"],function(e,t,n,i,r,a,o,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d,l=e("when");!function(e){function t(e){for(var t="",n=0;n<e.length;n++)t+="'"+e[n]+"',";return t.substring(0,t.length-1)}function d(e){var t=document.createElement("div");return t.innerHTML=e.trim(),c(t,0).innerHTML}function c(e,t){for(var n,i=new Array(1+t++).join("  "),r=new Array(t-1).join("  "),a=0;a<e.children.length;a++)n=document.createTextNode("\n"+i),e.insertBefore(n,e.children[a]),c(e.children[a],t),e.lastElementChild===e.children[a]&&(n=document.createTextNode("\n"+r),e.appendChild(n));return e}function u(e,t,a,o){var s=i.default.openFiles[i.default.selectedEditor].runtimeEditor;if(s&&s._sceneActionState.pasteWidget&&i.default.copiedWidgets.widgets[e.id]&&i.default.copiedWidgets.widgets[e.id].nestedElementId){var d=e.id,l=i.default.generateRandomId(e.type);e.id=l,t.id=l,s.cloneAnimations(l,d)}else void 0!==e.id&&(t.id=e.id);if(void 0!==e.className)if(""!==t.className)for(var c=e.className.split(" "),u=c.length,f=0;f<u;f++)t.classList.add(c[f]);else t.className=e.className;if(void 0!==e.background&&(t.style.background=e.background,t.style.backgroundRepeat="repeat"),e.styles.mixBlendMode&&"normal"===e.styles.mixBlendMode&&(t.style.mixBlendMode=e.styles.mixBlendMode),e.styles.backgroundBlendMode&&"normal"===e.styles.backgroundBlendMode&&(t.style.backgroundBlendMode=e.styles.backgroundBlendMode),e.selected&&t.setAttribute("selected","selected"),e.multiple&&t.setAttribute("multiple","multiple"),e.checked&&t.setAttribute("checked","checked"),void 0!==e.attrs&&x(t,e.attrs),void 0!==e.dataBindings){var p=e.dataBindings;for(var m in p)""!==p[m]&&t.setAttribute(n.default.DataBindingGroups[m],p[m])}if(void 0!==e.styles&&C(t,e.styles,e.type),void 0!==e["-webkit-filter"]&&O(t,e["-webkit-filter"],"webkitFilter"),void 0!==e.geometry&&C(t,e.geometry,e.type),"Hummingbird"!==i.default.preferences.couiEnvironment||void 0!==t.style.maskImage&&""!==t.style.maskImage||void 0===o||(t.style.mask="",t.style.maskSize="",t.style.maskRepeat="",t.style.maskPosition="",t.style.maskImage=""),void 0!==e.transform&&void 0!==e.transform.rotate?t.style.transform="rotate("+e.transform.rotate+")":void 0!==e.transform&&(t.style.transform=r.default.buildTransformStyles(e)),e["transform-origin"]){var g=e["transform-origin"]["transform-origin-x"]||"50%",v=e["transform-origin"]["transform-origin-y"]||"50%";t.style.transformOrigin=g+"  "+v}if(e["perspective-origin"]){var h=e["perspective-origin"]["perspective-origin-x"]||"50%",y=e["perspective-origin"]["perspective-origin-y"]||"50%";t.style.perspectiveOrigin=h+"  "+y}if(void 0!==e.boxShadow){var b=e.boxShadow;"none"===b.insetOutset?b.insetOutset="":b.insetOutset=b.insetOutset+" ",t.style.boxShadow=b.insetOutset+b.horizontalLength+" "+b.verticalLength+" "+b.blurRadius+" "+b.spreadRadius+" "+b.color}if(void 0!==e.text&&(t.textContent=e.text),void 0!==e["-coherent-layer-clip-aa"]&&(t.style["-coherent-layer-clip-aa"]=e["-coherent-layer-clip-aa"]),void 0!==e.color&&(t.style.color=e.color),void 0!==e.fontSize&&""!==e.fontSize&&(t.style.fontSize=e.fontSize),void 0!==e.fontFamily&&(t.style.fontFamily=e.fontFamily),"liveview"===e.type&&t.setAttribute("src","liveview://"+e.attrs.src.trim()),void 0!==e.children&&e.children.length>0&&R(t,e.children,o),e.type&&(e.widgetkit?t.setAttribute("data-type","widget"):t.setAttribute("data-type",e.type)),e.widgetkit&&t.setAttribute("data-widgetkit",e.widgetkit),e.events&&o&&o.options)for(var w in e.events)if(e.events.hasOwnProperty(w)){var E=e.events[w];for(var k in E)E.hasOwnProperty(k)&&("javascriptFunction"===k?t.setAttribute("data-"+w,E[k]):t.setAttribute("data-"+w,k+"("+E[k]+")"))}t.setAttribute("data-element-type","widget"),t.setAttribute("data-element-selectable","true"),$(t).on("mousedown",function(e){s.inputSearch.focusout(),e.preventDefault()}),e.selectable=!0,a.appendChild(t),void 0!==o?o.options||o.runtimeEditor.recalculateUnits(t,e.id):void 0!==e.events&&_(t,e.events)}function f(e,t,n,i){for(var r=document.createDocumentFragment(),a=e.widgets,o=a.length,s=0;s<o;++s)S(a[s],r,i);if(t.appendChild(r),D(t),void 0!==i){var d=$("#scene video");i.runtimeEditor.displayVideos(d),void 0!==i.endAllCallback&&i.endAllCallback()}return l()}var p={},m=a.default.nonDisplayInheritElements,g=function(){return void 0!==window.globalEditorInfo};window.engine=window.engine||void 0;var v=function(){return window.engine&&void 0!==window.engine.on};document.createElement("style").id="style-runtime",g()&&(vex.defaultOptions.className="vex-theme-flat-attack");var h=function(e){if(void 0===e)return l();for(var t=e.length,n=[],i=0;i<t;++i)n.push(System.import("runtime_editor/"+e[i]).catch(function(e){console.error.bind(console),g()&&vex.dialog.alert(e)}));return l.all(n)},y=function(e,t,n){return h(e.deps).then(function(i){var r=e.styles.length;if(0!==r)for(var a=0;a<r;a++){var o=document.createElement("link");o.rel="stylesheet",o.property="stylesheet",o.type="text/css",o.className="styles",o.href=e.styles[a],t.appendChild(o)}return f(e,t,0,n)}).then(function(){var n,i=e.scripts.length;if(0!==i)for(var r=0;r<i;r++)(n=document.createElement("script")).className="scripts",n.src=e.scripts[r],t.appendChild(n)}).then(function(){return E(e.widgets,t,e,n)}).then(function(){return b(e.animationClasses,t,n)}).then(function(i){return $(t).find("*").css("cursor",""),k(t,i,e,n)})},b=function(e,t,n){for(var i=Object.keys(e),r=0;r<i.length;r++)$.isEmptyObject(e[i[r]].keyframes)&&delete e[i[r]];return n.runtimeEditor.Animations.exportToCss(e)},w=function(e,n){var i,r;if(e.children.length)for(var a in e.children)e.children.hasOwnProperty(a)&&(n=w(e.children[a],n));if(e.events){i=e.events,r='document.getElementById("'+e.id+'")';for(var o in i){var s=i[o];for(var d in s)switch(d){case"javascriptFunction":n+=r+'.addEventListener("'+o+'", function() { '+s[d]+" });\n";break;case"engineCallArguments":n+=r+'.addEventListener("'+o+'", function() { engine.call.apply(engine, ['+t(s[d])+"]); });\n";break;case"engineTriggerArguments":n+=r+'.addEventListener("'+o+'", function() { engine.trigger.apply(engine, ['+t(s[d])+"]); });\n";break;case"blueprintFunction":n+=r+'.addEventListener("'+o+"\", function() { engine.trigger('"+s[d]+"'); });\n"}}}return n},E=function(e,t,n,i){var r=document.createElement("script"),a=document.createElement("script"),o=n.sceneEvents.sceneLoad,s="";r.className="local-events",a.className="global-events",a.textContent=o;for(var d in e)s=w(e[d],s);r.textContent="(function(){\n"+s+"\n})();\n",t.appendChild(a),t.appendChild(r)},k=function(e,t,n,a){var l="",c="",u="",f="",p=i.default.openFiles[i.default.selectedEditor],m=i.default.preferences.couiEnvironment,g=i.default.environmentProperties;if(0!==n.fonts.length&&n.fonts.map(function(e){u+=r.default.buildFontCss(e)}),a.options&&a.options.publishScene){var v=r.default.buildPublishPage(e,m);f="\n"+g.ORIGINAL_SOURCE_SCENE_PATH+"\n\n\x3c!-- "+a.options.originalSceneName+" --\x3e\n\n"+g.ORIGINAL_SOURCE_SCENE_PATH_END,l=u+"\n"+v.css,c=v.cleanedHTML,u=""}else u='<style id="coui_font_faces">\n'+u+"</style>",c=e.innerHTML;var h="scene";if(p.runtimeEditor){var y=p.tab.tabWidgetState.editWidget,b=p.tab.tabWidgetState.createNewWidget;(y||b)&&n.widgets[0]&&n.widgets[0].widgetkit&&!n.widgets[0].widgetkit.endsWith(".component")&&(h=n.widgets[0].widgetkit),p.tab.tabWidgetState.createNewWidget=!1}var w='\'{"width": "'+n.sceneSize.width+'", "height": "'+n.sceneSize.height+'", "type": "'+n.sceneSize.type+"\"}'",E={style:n.style,sceneType:h};c=d(c);var k="body {background-color:"+n.style.backgroundColor+";}",A="";s.default.environment.GT===i.default.preferences.couiEnvironment?A=' * {\n\tmargin: 0;\n\tpadding: 0;\n\tbox-sizing: border-box;\n\tfont-family:"Helvetica Neue",Helvetica, Arial,sans-serif;\n}\n':s.default.environment.Hummingbird===i.default.preferences.couiEnvironment&&(A=' * {\n\tbox-sizing: border-box;\n\tfont-family:"Helvetica Neue",Helvetica, Arial,sans-serif;\n}\n');var S="";if(s.default.environment.Hummingbird===i.default.preferences.couiEnvironment){S="body {\n\twidth: 100vw;\n\theight: 100vh;\n}\n";var x=/(?:flex-flow:|-webkit-flex-flow:)(.*?)(?:;)/gm;c=(c=c.split(x).map(function(e){if(-1===e.indexOf(">")&&-1===e.indexOf("<")){var t=e.trim().split(" ");return"flex-direction: "+t[0]+";"+" "+("flex-wrap: "+t[1]+";")}return-1!==e.indexOf("-webkit-")?e.replace(/-webkit-/gm,""):e}).join("")).replace(/.mask:.*?;/gm,function(e){var t=" mask-image: ";return t+=e.match(/url\(.*?\)/)[0]+"; mask-position: ",t+=e.match(/\).*?\//)[0].replace(") ","").replace(" /","")+"; mask-repeat: ",t+=e.match(/(repeat|no-repeat).*?;/)[0]})}else s.default.environment.GT===i.default.preferences.couiEnvironment&&(c=c.replace(/-webkit-mask:.*?;/gm,function(e){return e.replace("/ inherit ","")}));var C="<script>\n"+g.EDITOR_VERSION_MARK_START+'\nvar version = "'+i.default.EDITOR_VERSION.join(".")+'"; \n'+g.EDITOR_VERSION_MARK_END+"\n"+g.EDITOR_ENV_MARK_START+'\nvar environment = "'+i.default.preferences.couiEnvironment+'"; \n'+g.EDITOR_ENV_MARK_END+"\n"+g.ASPECT_RATIO_MARK_START+"\nvar sceneAspectRatio = "+w+"\n"+g.ASPECT_RATIO_MARK_END+"\n"+o.default.marker.scenePropertiesStart+"\n var sceneProperties = "+JSON.stringify(E)+"\n"+o.default.marker.scenePropertiesEnd+"\n<\/script>\n";return f+"\n"+g.COMMENT_MARK_START+"\n"+t+"\n"+(a.options&&a.options.publishScene?"":C)+u+"<style>\n"+A+S+k+"\n"+l+"</style>\n</head>\n<body>\n"+c+"\n"+g.COMMENT_MARK_END+"\n"},A=function(e,t){return l(System.import("runtime_editor/"+e+"!text")).then(function(e){return e=JSON.parse(e),y(e,t)})},S=function(e,t,n){var i=p[e.type];return void 0===i&&(i=p[e.type]=function(){var n=document.createTextNode(JSON.stringify(e));t.appendChild(n)}),i(e,t,n)},x=function(e,t){for(var n in t)""!==t[n]&&e.setAttribute(n,t[n])},C=function(e,t,n){for(var i in t)if(N(i,t[i],n))if("backgroundSize"===i&&"auto"===t[i]){var r=t.backgroundSizeWidth||"auto",a=t.backgroundSizeHeight||"auto";e.style[i]=r+" "+a}else if("-webkit-mask-size"===i&&"auto"===t[i]){var o=t["-webkit-mask-sizeWidth"]||"auto",s=t["-webkit-mask-sizeHeight"]||"auto";e.style[i]=o+" "+s}else e.style[i]=t[i]},N=function(e,t,n){return(-1===["textTransform","textDecoration","backgroundSizeWidth, backgroundSizeHeight","-webkit-mask-sizeWidth","-webkit-mask-sizeHeight"].indexOf(e)||"none"!==t)&&!("display"===e&&"inherit"===t&&!m.includes(n))},O=function(e,t,n){var i="";for(var a in t){var o=t[a];"rotate"===a&&(o=r.default.toDegrees(parseFloat(o))+"deg"),"dropShadowColor"!==a&&"dropShadowX"!==a&&"dropShadowY"!==a&&"dropShadowBlur"!==a&&(i+=a+"("+o+") ")}i+=r.default.buildDropShadowProperty(t),e.style[n]=i},_=function(e,t){v()?T(e,t):(System.config({paths:{coherent:"lib/coherent.js"}}),System.import("runtime_editor/coherent").then(function(n){window.engine=n,T(e,t)}))},T=function(e,t){var n;for(n in t)!function(t){"object"==typeof t?t.engineCallArguments?e.addEventListener(n,function(){engine.call.apply(engine,t.engineCallArguments)},!1):t.engineTriggerArguments?e.addEventListener(n,function(){engine.trigger.apply(engine,t.engineTriggerArguments)},!1):t.blueprintFunction?e.addEventListener(n,function(){engine.trigger(t.blueprintFunction)},!1):t.javascriptFunction&&e.addEventListener(n,new Function(t.javascriptFunction),!1):e.addEventListener(n,window.editorEvents[t],!1)}(t[n])},R=function(e,t,n){for(var i=t.length,r=0;r<i;++r)S(t[r],e,n)},I=function(e,t,n){u(e,"ellipse"===e.type||"rectangle"===e.type||"roundedRect"===e.type||"circle"===e.type||"responsiveImage"===e.type||"widget"===e.type?document.createElement("div"):document.createElement(e.type),t,n)},M=function(e,t,n){var i=document.createElement("input");"inputText"===e.type?i.setAttribute("type","text"):i.setAttribute("type",e.type),"range"===e.type&&$(i).val(0).trigger("change"),u(e,i,t,n)},F=function(e,t,n){var i=new Image;i.src=e.url,void 0!==e.width&&(i.width=e.width),void 0!==e.height&&(i.height=e.height),u(e,i,t,n)};p={widget:I,div:I,responsiveImage:I,image:F,liveview:F,video:function(e,t,n){var i=document.createElement("video");i.src=e.url,u(e,i,t,n)},text:function(e,t,n){var i=document.createElement("div");i.textContent=e.text,u(e,i,t,n)},label:I,button:I,inputText:M,select:I,range:M,number:M,option:I,checkbox:M,radio:M,textarea:I,ul:I,ol:I,li:I,rectangle:I,ellipse:I,circle:I,roundedRect:I};var z=function(e,t){for(var n=0;n<e.length;n++)e[n].attributes&&(e[n].hasAttribute("data-element-selectable")&&e[n].removeAttribute("data-element-selectable"),e[n].setAttribute("data-parent-widget-id",t.id)),e[n].childNodes.length>0&&z(e[n].childNodes,t)},D=function(e){var t=e.querySelectorAll('[data-type="widget"]'),n=t.length;if(n>0)for(var r=0;r<n;r++){var a=t[r].childNodes,o=i.default.openFiles[i.default.selectedEditor].tab.tabWidgetState;o.importedWidget&&!o.editWidget&&z(a,t[r])}};e.setupProperties=u,e.createComponent=function(e,t){var n=document.createDocumentFragment();S(e,n,t);var i=$("<div></div>");return i[0].appendChild(n),i.html()},e.loadAndCreateObj=function(e,t,n){return y(e,t,n)},e.loadAndCreate=function(e,t){return A(e,t)},e.create=f,e.createAnElement=function(e,t,n){var i=document.createDocumentFragment();S(e,i,n),t.appendChild(i),D(t)},e.addFactory=function(e,t){p[e]=t},e.promise=function(e){return l(e)},e.factoriesExport=p}(d=t.runtimeCore||(t.runtimeCore={})),t.default={loadSceneObj:d.loadAndCreateObj,load:d.loadAndCreate,create:d.create,createAnElement:d.createAnElement,addFactory:d.addFactory,promise:d.promise,setupProperties:d.setupProperties,createComponent:d.createComponent,factories:d.factoriesExport}});