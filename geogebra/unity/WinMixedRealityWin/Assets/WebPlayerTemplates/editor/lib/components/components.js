var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function i(e){try{s(o.next(e))}catch(e){a(e)}}function l(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(i,l)}s((o=o.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return o([e,t])}}function o(n){if(r)throw new TypeError("Generator is already executing.");for(;l;)try{if(r=1,a&&(i=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(i=i.call(a,n[1])).done)return i;switch(a=0,i&&(n=[0,i.value]),n[0]){case 0:case 1:i=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,a=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(i=l.trys,!(i=i.length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){l.label=n[1];break}if(6===n[0]&&l.label<i[1]){l.label=i[1],i=n;break}if(i&&l.label<i[2]){l.label=i[2],l.ops.push(n);break}i[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],a=0}finally{r=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,a,i,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return{next:n(0),throw:n(1),return:n(2)}};define(["require","exports","lib/enums","../../scripts/helpers/units_conversion","../../scripts/main"],function(e,t,n,o,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(){this.components={},this.state={opened:[]}}return e.prototype.create=function(e,t){this.components[e]=t;var n=r.default.openFiles[r.default.selectedEditor].runtimeEditor;return n._sceneActionState.createComponent=!0,n.saveUndoRedo(null,null,null,{componentName:e},null),n.exportScene(),this},e.prototype.isComponentOpened=function(e){for(var t=0;t<this.state.opened.length;t++){var n=this.state.opened[t];if(r.default.openFiles[n].tab.filename===e)return this.state.opened[t]}return!1},e.prototype.remove=function(e){var t=this.isComponentOpened(e);t&&r.default.forceClose(t);var n=r.default.openFiles[r.default.selectedEditor].runtimeEditor;n._sceneActionState.deleteComponent=!0;var o=n.getRedoUndoPrimaryState(),a={name:e,json:this.components[e]},i=$('[data-widgetkit="'+e+'"]'),l=i.length;"new action"===o&&(n._undoCreationStepsLength=l+1),n.saveUndoRedo(null,null,null,a,null),delete this.components[e];for(var s=[],c=0;c<l;c++)s.push(i[c].getAttribute("id"));return n.removeWidgets(s),this},e.prototype.registerComponents=function(){var e=r.default.environmentProperties,t="\n"+e.REGISTER_COMPONENTS_MARK_START;t+="\n<script>";var n=0;for(var o in this.components)t+="\nvar component"+n+" = getComponentData('"+o+"');\n",t+="engine.registerComponent('"+o+"', {\n   template: component"+n+".template,\n   create: function () {\n      return this.appendChild(component"+n+".script);\n   }\n})\n",n++;return t+="function getComponentData(componentName) {\n   var el = document.querySelectorAll('[data-load-component-id=\"' + componentName + '\"]');\n   var html = document.createElement('html');   html.innerHTML = el[0].innerHTML;\n   var localEvents = html.getElementsByClassName('local-events')[0];\n   var script = document.createElement('script');\n   script.innerHTML = localEvents.innerHTML;\n   var component = html.querySelectorAll('[data-widgetkit=\"' + componentName + '\"]')[0];\n   return {\n       template: component,\n       script: script\n   };\n }\n",t+="\n<\/script>\n",t+=e.REGISTER_COMPONENTS_MARK_END+"\n"},e.prototype.replaceScriptTags=function(e,t){void 0===t&&(t=!1);return t?e.replace(/<x-script/g,"<script").replace(/<\/x-script/g,"</script"):e.replace(/<script/g,"<x-script").replace(/<\/script/g,"</x-script")},e.prototype.buildComponentExportHTML=function(){return __awaiter(this,void 0,void 0,function(){var e,t,n,o,a,i,l,s,c,p=this;return __generator(this,function(d){switch(d.label){case 0:e=$.Deferred(),t=r.default.environmentProperties,n=r.default.openFiles[r.default.selectedEditor],o="",a=[];for(i in this.components)a.push(i);l=0,d.label=1;case 1:return l<a.length?(s=a[l],o+='\n<script type="text/html" data-load-component-id="'+s+'">\n'+t.COMPONENTS_MARK_START+"\n",c=o,[4,n.runtimeEditor.runtimeLoad(this.components[s],{widgetSave:!0}).then(function(e){var n=r.default.rebuildUserHTML(e,"",!0),o=r.default.cleanupHtmlExport(n);return(o=p.replaceScriptTags(o))+"\n"+t.COMPONENTS_MARK_END+"\n\n<\/script>\n"}).catch(function(e){console.log(e.message)})]):[3,4];case 2:o=c+d.sent(),d.label=3;case 3:return l++,[3,1];case 4:return[2,e.resolve(o)]}})})},e.prototype.cleanupCommentMarks=function(e){var t=r.default.environmentProperties;return e.replace(t.COMPONENTS_MARK_START,"").replace(t.COMPONENTS_MARK_END,"")},e.prototype.load=function(e){var t=/\/\* Editor Components Start \*\/([\s\S]*?)\/\* Editor Components End \*\//gm;if(e.match(t)){var n=e.match(t);if(n.length>0){for(var o={},a=0;a<n.length;a++){n[a]=this.replaceScriptTags(n[a],!0),n[a]=this.cleanupCommentMarks(n[a]);var i=r.default.buildWidgetSceneObjFromHtml(n[a]);o[i.widgets[0].widgetkit]=JSON.stringify(i)}this.components=o}}},e.prototype.open=function(e,t){var n=this,o=r.default.selectedEditor;return r.default.openAsset({name:t,content:e}),$("body").off("__openComponentComplete"),$("body").on("__openComponentComplete",function(){var e=r.default.selectedEditor;-1===n.state.opened.indexOf(e)&&(r.default.openedTabsTypes.components.push(e),n.state.opened.push(e)),r.default.openFiles[r.default.selectedEditor].tab.tabWidgetState.instanceOf=o,document.body.dispatchEvent(new Event("__componentInstanceSet"))}),this},e.prototype.clearOpenedData=function(e){var t=this.state.opened.indexOf(e);return t>-1&&(r.default.openedTabsTypes.components.splice(t,1),this.state.opened.splice(t,1)),this},e.prototype.save=function(e,t){this.components[e]=t,r.default.EXPORTING_COMPONENT&&(r.default.EXPORTING_COMPONENT=!1),r.default.tabEdited(!1)},e.prototype._insertToTheScene=function(e,t){var n=e.getAttribute("data-url"),o=e.getAttribute("data-widget-name");""!==n?this._fetchWidgetFromFileAndInsertToTheScene(n,t):this._insertWidgetComponentToTheScene(o,t)},e.prototype._fetchWidgetFromFileAndInsertToTheScene=function(e,t){var o=this,a=r.default.openFiles[r.default.selectedEditor].runtimeEditor;r.default.globalEditorInfo.backend===n.default.Backends.Debug||r.default.globalEditorInfo.backend===n.default.Backends.Website?e+="!text":e=a.buildWidgetUrl(e),System.import(e).then(function(e){var n=o._getDroppedOffset(t),a="left: "+n.x+"vw; ",i=" top: "+n.y+"vh; ",l=/<([\s\S]*)<\/head>/,s=/<body>([\s\S]*)<\/body>/.exec(e.valueOf())[0],c=/(top:).*?;/,p=/(left:).*?;/,d=""+l.exec(e.valueOf())[0]+(s=(s=s.replace(s.match(c)[0],i)).replace(s.match(p)[0],a))+"</html>",u=r.default.selectedEditor,f=r.default.openFiles[r.default.selectedEditor].tab.filename;r.default.openFiles[r.default.selectedEditor].tab.tabWidgetState.importedWidget=!0,r.default.handleFileContent(d,f,u,!1,!0)})},e.prototype._getDroppedOffset=function(e){var t=r.default.openFiles[r.default.selectedEditor].runtimeEditor._getSceneOffset(e);return{x:o.default.convertPixelToVw(t.x),y:o.default.convertPixelToVh(t.y)}},e.prototype._insertWidgetComponentToTheScene=function(e,t){var n=r.default.openFiles[r.default.selectedEditor],o=this._getDroppedOffset(t),a=JSON.parse(n.components.components[e]);a.widgets[0].geometry.top=o.y+"vh",a.widgets[0].geometry.left=o.x+"vw";var i=r.default.selectedEditor,l=n.tab.filename;n.tab.tabWidgetState.importedWidget=!0,r.default.handleFileContent(JSON.stringify(a),l,i,!1,!0)},e}();t.default=a});