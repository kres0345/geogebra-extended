var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,a){function s(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,r)}l((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return i([e,t])}}function i(n){if(o)throw new TypeError("Generator is already executing.");for(;r;)try{if(o=1,a&&(s=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(s=s.call(a,n[1])).done)return s;switch(a=0,s&&(n=[0,s.value]),n[0]){case 0:case 1:s=n;break;case 4:return r.label++,{value:n[1],done:!1};case 5:r.label++,a=n[1],n=[0];continue;case 7:n=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){r=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){r.label=n[1];break}if(6===n[0]&&r.label<s[1]){r.label=s[1],s=n;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(n);break}s[2]&&r.ops.pop(),r.trys.pop();continue}n=t.call(e,r)}catch(e){n=[6,e],a=0}finally{o=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var o,a,s,r={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return{next:n(0),throw:n(1),return:n(2)}};define(["require","exports","lib/enums","lib/key_handlers","lib/function_helpers","lib/animations/importCss","lib/build_widget_settings","lib/editor_settings","lib/components/components"],function(e,t,n,i,o,a,s,r,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=0;!function(e){var t={open:0,pendingClose:1,safelyClosable:2},c={},p={},u=!1,f=function(){function e(){window.LOADING_SCREEN_ON=!1,this.missingWidgets=[],this.__mainSceneIdToBeClosed=null,this.PENDING_PUBLISH_PAGE_LOAD=!1,this.PENDING_WIDGET_EXPORT=!1,this.PENDING_WIDGET_LOAD=!1,this.EXPORTING_WIDGET=!1,this.PENDING_SCENE_LOAD=!1,this.EXPORTING_COMPONENT=!1,this._isClosingInOrder=!1,this.openFiles={},this.openedTabsTypes={scenes:[],components:[]},this.selectedEditor=null,this.autoReload=!0,this.autoReloadCallback=function(){console.log("auto 1")},this.onSelectedFileType={createNewScene:!1,publishPage:!1},this.$wrapperFilesEl=$("#wrapper-files"),this.$wrapperCodeEditor=$("#wrapper-editor"),this.$wrapperRuntimeEditor=$("#wrapper-runtime-editor"),this.widgetCount=0,this._isClosingAllTabs=!1,this._isExitingEditor=!1,this.fileId=1,this.reloadedRuntimeEditor=0,this.assets={image:[],video:[],sound:[],widget:[],style:[],script:[],font:[]},this.copiedWidgets={widgets:{},animationsToPaste:{},animations:{},tabName:""},this.animationsBackwardsCompatibility={idsToClasses:[]},this.animationBelongsTo="scene",this.currentOpenedTabs=[],this.classNamesCount=0,this.isBasicPanelOpen=!0,this.detachedAmnimationsHTML=null,this.detachedSceneHTML=null,this.sceneSettings={}}return e.prototype.init=function(){this.preferences=r.default.defaultPreferences,this._displayToolbar(),this._displayEditMenu(),this._displayMenu(),this._tabsHandlers(),this._attachMouseCoordsHandlers(),this.initVexFlashMessages()},e.prototype.attachEditorHandlers=function(){var e=this;this.onsave=function(e,t){"widgets/"===this.openFiles[this.selectedEditor].tab.originalFullPath&&(e="widgets/"+e),engine.call("Save",e,t)},this.onExportWidget=function(e,t){return this.EXPORTING_WIDGET=!1,engine.call("ExportWidget",e,t)},this.onreload=function(e){engine.call("Reload",e)},this.onclose=function(e){this.syncTabs(),engine.call("Close",e)},this.onLaunchUrl=function(e){engine.call("LaunchURL",e)},this.oncloseEditor=function(){engine.call("CloseEditor")},this.onopen=function(){engine.call("OpenFile")},this.listDirectory=function(e,t,n){return engine.call("ListDirectory",e,t,n)},this.openAsset=function(e){var t=e.path,n=e.name,i=e.content;return i?engine.trigger("LoadFile",n,i):engine.call("OpenAsset",t)},this.pickAsset=function(t,n){var i=e.environmentProperties.DefaultExtensions[n].map(function(e){return"*."+e}).join(";");return i="Coherent files ("+i+";):"+i+";",engine.call("PickAssetWithExtensions",t,n,i)}},e.prototype.attachBrowserHandlers=function(){var e=this;System.import("uiresources/one.html!text").then(function(t){e.openFile(t,"MainUI.html")})},e.prototype.buildTestScene=function(e,t){function n(){i=setTimeout(function(){return o.openFiles[o.selectedEditor].runtimeEditor.undoRedoScene("redo"),0===o.openFiles[o.selectedEditor].redo.length?a.resolve():n()},50)}var i,o=this,a=$.Deferred();return this.openFiles[this.selectedEditor].redo=e,n(),a.promise()},e.prototype.runCommands=function(e,t){function n(){i=setTimeout(function(){if(o.openFiles[o.selectedEditor].runtimeEditor.undoRedoScene("redo"),0===o.openFiles[o.selectedEditor].redo.length){o.openFiles[o.selectedEditor].runtimeEditor.exportScene();var e=o.openFiles[o.selectedEditor].file;return o.openFiles[o.selectedEditor].runtimeEditor.runtimeLoad(e,{sceneSave:!0}).then(function(e){var n=o.rebuildUserHTML(e),r=o.cleanupHtmlExport(n).replace(/\r/g,"").trim(),l=t.originalFile;return System.import(l+"!text").then(function(e){var t=e.replace(/\r/g,"").trim();clearTimeout(i),t!==r?console.error("functional test failed!"):console.log("functional test passed!"),a.resolve(t===r),s(t,r)})})}return n()},50)}var i,o=this,a=$.Deferred();this.openFiles[o.selectedEditor].redo=e;var s=function(e,t){System.import("bower_components/jsdiff/diff.min").then(function(n){for(var i=n.diffWordsWithSpace(e,t),o=[],a="",s=0;s<i.length;s++)a+="%c"+i[s].value,i[s].removed?o.push("color: red"):i[s].added?o.push("color: green"):o.push("color: grey");console.log.apply(console,[].concat(a,o))})};return n(),a.promise()},e.prototype._attachMouseCoordsHandlers=function(){document.addEventListener("mousemove",function(e){window.mouseCoordsX=e.pageX,window.mouseCoordsY=e.pageY},!1)},e.prototype.widgetEditingHandlers=function(){var e=this.openFiles[this.selectedEditor].tab.tabWidgetState.editWidget;return $(".btn-export-widget").toggle(!e),$(".btn-createWidget-scene").toggle(!e),$(".widgets-content").toggle(!e),this},e.prototype.adjustPreferences=function(){var e=this;if(this.globalEditorInfo.backend!==n.default.Backends.Debug&&this.globalEditorInfo.backend!==n.default.Backends.Website)var t,i,o=engine.call("prefs.get","preferences").result.couiEnvironment,a=vex.dialog.open({closeOnOverlayClick:!0,contentClassName:"modal-about",message:"Environment is "+o+". If changed the editor will be reset!",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok",click:function(){t=!0,a.data().vex.value=!1,vex.close(a.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){t=!1,a.data().vex.value=!1,vex.close(a.data().vex.id)}})],afterOpen:function(n){t=!1;var a=document.querySelector("#vex-preferences-set"),s=e.importHtmlTemplate(a),r=s.querySelector("#environment-dropdownlist"),l=["GT","Hummingbird"];l.splice(l.indexOf(o),1),l.unshift(o),$(r).kendoDropDownList({dataSource:l,animation:!1}),(i=s.querySelector("[aria-activedescendant]")).id="new-editor-environment-set",n.append(s)},callback:function(n){if(t){var a=$("#"+i.id).find("#environment-dropdownlist").data("kendoDropDownList").span[0].textContent;o!==a&&e.changeEngineEnv(a)}}});else vex.dialog.alert({closeOnOverlayClick:!0,contentClassName:"modal-about",message:"Environment preference settings are not available in the Web!"})},e.prototype.tabEdited=function(e,t){var n=w2ui.tabs.tabs,i=t||this.selectedEditor;i=i.replace("editor","");for(var o=0;o<n.length;o++){var a=n[o];if(a.id.replace("tab","")===i){var s=a.text.replace(/()\*+/g,"");a.caption=a.text=e?"*"+s:s,w2ui.tabs.refresh("tab"+i);break}}},e.prototype.refreshTab=function(){var e=this.selectedEditor,t=this.openFiles[e],n=t.runtimeEditor;this.handleFileContent(JSON.stringify(n.scene),t.tab.filename,e,!1,!1)},e.prototype.wasTabEdited=function(e){for(var t=w2ui.tabs.tabs,n=e.replace("editor",""),i=0;i<t.length;i++){var o=t[i];if(o.id.replace("tab","")===n)return-1!==o.text.indexOf("*")}},e.prototype._tabsHandlers=function(){var e=this;$("#tabs").w2tabs({name:"tabs",tabs:[],onClose:function(n){var i="editor"+n.object["data-id"],o=e.openFiles[i],a=o.tab.filename,s=o.tab.state;if(!a.endsWith(".component")&&o.components&&0!==o.components.state.opened.length)return e.closeTabsInOrder(n.target),void n.preventDefault();var r=!0;if(s!==t.safelyClosable&&e.wasTabEdited(i)){var l=[$.extend({},vex.dialog.buttons.NO,{text:"Save",click:function(){d.data().vex.value=!0,vex.close(d.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Discard",click:function(){d.data().vex.value=!1,vex.close(d.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){d.data().vex.value="cancel",vex.close(d.data().vex.id),e._isClosingAllTabs=!1}})];!0===e._isExitingEditor&&l.splice(2,1);var d=vex.dialog.open({contentClassName:"modal-about save-modal",message:"Do you want to save "+a+" ?",buttons:l,afterOpen:function(){r=!1},callback:function(o){if("cancel"!==o){if(o)return e.openFiles[i].tab.state=t.pendingClose,e.save(a,e.openFiles[i].file.valueOf(),null,i),void n.preventDefault();e.clearTab(i,n)}}})}r?setTimeout(function(){e.clearTab(i,n)},100):n.preventDefault()},onClick:function(t){var n=t.object["data-id"],i="editor"+n,o=e.openFiles[i];i===e.selectedEditor&&e.PENDING_SCENE_LOAD||(e.PENDING_SCENE_LOAD=!0,engine.call("SetCurrentSceneURL",e.openFiles[i].tab.filePath),e._isClosingAllTabs||(window.CURRENT_FILE=o.tab.filename,document.body.dispatchEvent(new Event("turnOnLoadingScreen"))),window.requestAnimationFrame(function(){$(".editor").hide(),$("#"+i).show();var t=o.file.valueOf();document.body.dispatchEvent(new CustomEvent("coui.tab.change")),e.selectedEditor=i,"html"===o.tab.fileExtension&&(e.usesSceneEditor(t)||e.photoshopExport(t))||"component"===o.tab.fileExtension?(e.handleFileContent(t,o.tab.filename,i,!1,!1),e._initTabsTooltip(n,o.tab.filename)):(e.$wrapperRuntimeEditor.hide(),e.$wrapperCodeEditor.show(),document.body.dispatchEvent(new Event("couiEditorIsReadyForUse")))}))}})},e.prototype.initSceneConfigVex=function(){var e=this,t="";System.import("templates/editor/scene_create_new.hbs!text").then(function(e){t=e}),$(window).on("createNewScene",function(){var i=[$.extend({},vex.dialog.buttons.NO,{text:"OK",click:function(){e.PENDING_SCENE_LOAD=!1,e.sceneSettings={backgroundColor:$(".init-scene-background-picker").data("kendoColorPicker").value(),width:$(".init-aspect-ratio-width-custom").val(),height:$(".init-aspect-ratio-height-custom").val(),type:$("select.init-scene-aspect-ratio").val()};var t=e.sceneSettings,i=t.type,s=t.width,r=t.height,l=o.default.getSceneSizeByType(i,s,r);e.globalEditorInfo.backend===n.default.Backends.Debug||e.globalEditorInfo.backend===n.default.Backends.Website?e.createNewTestScene(!1,{style:{backgroundColor:e.sceneSettings.backgroundColor},sceneSize:l}):engine.call("ShowFileDialog",{__Type:"FileDialogConfig",extensions:[".html"],dialogName:"Save New Scene As",initDirectory:"",fileMustExist:!1,isOpenFile:!1,allowMultiselect:!1}),a.data().vex.value=!0,vex.close(a.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){e.PENDING_SCENE_LOAD=!0,a.data().vex.value=!1,vex.close(a.data().vex.id)}})],a=vex.dialog.open({contentClassName:"modal-about",message:"New file",buttons:i,afterOpen:function(i){var o=e.Handlebars.compile(t)(n.default.newScene);i.append(o);var a=i.find(".init-scene-aspect-ratio");a.kendoDropDownList({});var s=i.find(".init-scene-background-picker"),r=i.find(".init-aspect-ratio-custom");s.kendoColorPicker({buttons:!1,value:"rgba(255, 255, 255, 0)",opacity:!0}),a.on("change",function(){"aspectRatio_custom"===$(this).val()?r.show():r.hide()})}})})},e.prototype.syncTabs=function(){var e=this,t=w2ui.tabs.tabs,n=Object.keys(this.openFiles);if(t.length!==n.length)for(var i=t.map(function(e){return e.path+e.text.replace("*","")}),o=n.map(function(t){return e.openFiles[t].tab.filePath+e.openFiles[t].tab.filename.replace("*","")}),a=0;a<i.length;a++)-1===o.indexOf(i[a])&&w2ui.tabs.remove(t[a].id)},e.prototype.clearTab=function(e,t){var n=this,i=$("#"+e),o=this.openFiles[e],a=o.tab.filename,s=w2ui.tabs.tabs;if(a.endsWith(".component")){var r=this.openFiles[this.selectedEditor].tab.tabWidgetState.instanceOf||o.tab.tabWidgetState.instanceOf;this.openFiles[r].components.clearOpenedData(e)}if(delete p[e],localStorage.removeItem(e),w2ui.tabs.active===t.target&&s.length>1){var l=(n._getActiveTabIndex()+1)%s.length;if(this._isClosingInOrder&&this.__mainSceneIdToBeClosed){var d=this.__mainSceneIdToBeClosed;0!==this.openFiles[this.__mainSceneIdToBeClosed].components.state.opened.length&&(d=this.openFiles[this.__mainSceneIdToBeClosed].components.state.opened[0]);var c=d.replace("editor","tab");this.focusFileOnClose(i,c)}else this.focusFileOnClose(i,s[l].id)}else i.remove();delete this.openFiles[e],void 0!==this.onclose&&this.onclose(a),this._isClosingAllTabs&&setTimeout(this.closeAllTabs.bind(n),100),this._isClosingInOrder&&setTimeout(this.closeTabsInOrder.bind(n),100),0===s.length&&this.$wrapperCodeEditor.hide()},e.prototype.buildHTML=function(e,t){var n=document.createElement("div");return n.className="temp-holder",n.innerHTML=e,this.buildJSON(n,t)},e.prototype._getActiveTabIndex=function(){for(var e=w2ui.tabs.tabs,t=0;t<e.length;t++)if(e[t].id===w2ui.tabs.active)return t;return e.length-1},e.prototype.focusFileOnClose=function(e,t){e.hide(),e.remove(),w2ui.tabs.click(t)},e.prototype.updateSceneAssets=function(e){var t=!1;this.globalEditorInfo.backend!==n.default.Backends.Debug&&this.globalEditorInfo.backend!==n.default.Backends.Website||(t=!0);for(var i=0;i<e.length;i++)if(e[i].isFile&&"meta"!==e[i].url.split(".").pop()&&("FileEntry"!==e[i].__Type&&"FEditorFileEntry"!==e[i].__Type||(e[i].__Type=o.default.getFileType(e[i].url)),e[i].__Type)){e[i].name||(e[i].name=e[i].url.replace(/\//gm,"\\"));var a=e[i].url.split("\\").join("/");e[i].url=t?"uiresources/"+a:a,this.assets[e[i].__Type].push(e[i])}if(this.selectedEditor){var s=this.openFiles[this.selectedEditor].components.components;for(var r in s)this.assets.widget.push({__Type:"widget",isFile:!1,name:r,url:""})}},e.prototype.rebuildRuntimeEditor=function(e,t,n,i){var o=this;document.body.dispatchEvent(new CustomEvent("coui.editor.rebuild")),$("#wrapper-runtime-editor *").each(function(){$(this).unbind(),$(this).off("blur").off("focus").off("focusin").off("focusout").off("resize").off("scroll").off("click").off("dbclick").off("mousedown").off("mouseup").off("mousemove").off("mouseover").off("mouseout").off("mouseenter").off("mouseleave").off("change")}),this.$wrapperCodeEditor.hide(),this.$wrapperRuntimeEditor.show(),this.initRuntimeEditorHtml(i).then(function(){o.createRuntimeEditor(e,t,i)})},e.prototype.cleanCoherentTags=function(e){var t,n=/((<style[^<]*.CSS Animations Start([\s\S]*?)CSS Animations End*[^>]*<\/style>)[\s\S]*?)/g,i=/((<script[^<]*.Aspect Ratio Start([\s\S]*?)Aspect Ratio End*[^>]*<\/script>)[\s\S]*?)/g;return e&&(t=e.replace(n,"").replace(i,"").trim()),t},e.prototype.rebuildUserHTML=function(e,t,i){void 0===t&&(t=""),void 0===i&&(i=!1);var o,a,s=/<!-- Coherent Editor Start -->([\s\S]*)<!-- Coherent Editor End -->/,r=this.openFiles[this.selectedEditor],l=[],d=[],c="";return r.tab.originalHTML&&(o=r.tab.originalHTML.split(s)),""!==t&&Object.keys(r.components.components).length>0?(c=r.components.registerComponents(),a=r.tab.originalHTML):""!==t||i||!o||o[0]===n.default.defaultHTML.top&&o[3]===n.default.defaultHTML.bottom||(a=r.tab.originalHTML.replace(n.default.componentWrapper,"").replace(n.default.componentRegister,"")),a&&""!==a?d=a.split(s):(d[0]=n.default.defaultHTML.top,d[2]=n.default.defaultHTML.bottom),l.push(this.cleanCoherentTags(i?n.default.defaultHTML.top:d[0]),e,t,c,this.cleanCoherentTags(i?n.default.defaultHTML.bottom:d[2])),l.join("")},e.prototype.adjustSavedContent=function(e,t){for(var n=JSON.parse(e),i=n.animationClasses,o=Object.keys(i),a=0;a<o.length;a++){var s=o[a];i[s].animationsData["-webkit-filter"]&&this.prepareFilterAnimationToExport(i,s),i[s].animationsData.transform&&this.prepareTransformAnimationToExport(i,s)}for(var r=function(e){if(n.animations[e.id]){var t=n.animations[e.id].className;n.animations[e.id][t]=n.animationClasses[t]}var i=e.boxShadow;!i||"0px"!==i.blurRadius||"rgb(0, 0, 0)"!==i.color&&"#000"!==i.color||"0px"!==i.horizontalLength||""!==i.insetOutset||"0px"!==i.spreadRadius||"0px"!==i.verticalLength||delete e.boxShadow,""===e.className&&delete e.className},l=0;l<n.widgets.length;l++){var d=n.widgets[l];if(t.boxShadowAndClasses){r(d);for(var c=0;c<d.children.length;c++)r(d.children[c])}t.textarea&&"textarea"===n.widgets.type&&delete n.widgets[a].styles.webkitUserSelect}return JSON.stringify(n)},e.prototype.prepareFilterAnimationToExport=function(e,t){var n=e[t].animationsData["-webkit-filter"];e[t].animationsData["-webkit-filter"]={};var i=Object.keys(n)[0];if(i){n[i].name=n[i].name.split("_"),n[i].name[2]="combined",n[i].name=n[i].name.join("_"),e[t].animationsData["-webkit-filter"].combined=n[i];for(var o=e[t].keyframes["-webkit-filter"],a=Object.keys(o).filter(function(e){return e}),s={},r=0;r<a.length;r++)for(var l=Object.keys(o[a[r]]),d=0;d<l.length;d++)s[l[d]]?s[l[d]].push(o[a[r]][l[d]]):s[l[d]]=[o[a[r]][l[d]]];for(var c=Object.keys(s),p=[],u=0;u<c.length;u++)p.push(this.openFiles[this.selectedEditor].runtimeEditor.Keyframes.TimelineScrub.performTimelineScrub(null,Number(c[u]),t,!0,"-webkit-filter"));for(u=0;u<p.length;u++){s[c[u]]=[];for(var f=0;f<p[u].length;f++)s[c[u]].push({group:"-webkit-filter",property:p[u][f].key,time:{seconds:c[u]},values:[p[u][f].value]})}var h=$.extend(!0,{},s[c[0]][0]);h.values[0]="",h.time.seconds="";var m;m=c.reduce(function(e,t){return e[t]=$.extend(!0,{},h),e[t].time.seconds=parseInt(t),e},{});for(var g=0;g<c.length;g++){var v=s[c[g]].map(function(e){return"dropShadow"===e.property?e.values[0].trim():e.property+"("+e.values[0].trim()+")"}).join(" ");m[c[g]].property="-webkit-filter",m[c[g]].values[0]=m[c[g]].values[0]+v}e[t].keyframes["-webkit-filter"]={},e[t].keyframes["-webkit-filter"].combined=m}},e.prototype.prepareTransformAnimationToExport=function(e,t){var n=e[t].animationsData.transform;e[t].animationsData.transform={};var i=!1;n["transform-origin"]&&(i=!0,e[t].animationsData.transform["transform-origin"]=n["transform-origin"],delete n["transform-origin"]);var a=Object.keys(n)[0];if(a){n[a].name=n[a].name.split("_"),n[a].name[2]="combined",n[a].name=n[a].name.join("_"),e[t].animationsData.transform.combined=n[a];for(var s=e[t].keyframes.transform,l=Object.keys(s).filter(function(e){return"transform-origin"!==e}),d={},c=0;c<l.length;c++)for(var p=Object.keys(s[l[c]]),u=0;u<p.length;u++)d[p[u]]?d[p[u]].push(s[l[c]][p[u]]):d[p[u]]=[s[l[c]][p[u]]];for(var f=Object.keys(d),h=[],m=0;m<f.length;m++)h.push(this.openFiles[this.selectedEditor].runtimeEditor.Keyframes.TimelineScrub.performTimelineScrub(null,Number(f[m]),t,!0,"transform"));for(m=0;m<h.length;m++){d[f[m]]=[];for(var g=0;g<h[m].length;g++)d[f[m]].push({group:"transform",property:h[m][g].key,time:{seconds:f[m]},values:[h[m][g].value]})}var v=$.extend(!0,{},d[f[0]][0]);v.values[0]="",v.time.seconds="";var b;b=f.reduce(function(e,t){return e[t]=$.extend(!0,{},v),e[t].time.seconds=parseInt(t),e},{}),d=o.default.reorderTransform(d);for(var y=0;y<f.length;y++){var E=d[f[y]].map(function(e){return e.property+"("+e.values[0].trim()+")"}).join(" ");this.preferences.couiEnvironment===r.default.environment.Hummingbird&&(E=o.default.rebuildTransformForHb(E)),b[f[y]].property="transform",b[f[y]].values[0]=b[f[y]].values[0]+E}i?(i=e[t].keyframes.transform["transform-origin"],e[t].keyframes.transform={},e[t].keyframes.transform["transform-origin"]=i):e[t].keyframes.transform={},e[t].keyframes.transform.combined=b}},e.prototype.getExtension=function(e,t){return e.endsWith(".component")?n.default.extensions.component:this.openFiles[t].tab.fileExtension},e.prototype.save=function(e,t,i,o){return __awaiter(this,void 0,void 0,function(){var a,s,r,l,d,c,p,u,f,h,m=this;return __generator(this,function(g){switch(g.label){case 0:return a=o||this.selectedEditor,s=this.openFiles[a],r=this.getExtension(e,a),l=s.tab.filePath,d=e.replace(/.*[\\\/]/,""),c=null,p=null,s.runtimeEditor&&(c=s.runtimeEditor.Timeline,0!==(p=c.pinCurrentSeconds)&&c.setPinheadPosition(null,0),this.EXPORTING_WIDGET||(t=JSON.stringify(s.runtimeEditor.scene))),r===n.default.extensions.html&&s.runtimeEditor&&(t=this.adjustSavedContent(t,{boxShadowAndClasses:!0,textarea:!0})),r!==n.default.extensions.component?[3,1]:(u=s.tab.tabWidgetState.instanceOf||a,this.openFiles[u].components.save(d,t),this.onSaveCompleted(d,d),this.tabEdited(!0,u),[3,6]);case 1:return this.EXPORTING_WIDGET?[3,5]:void 0===a?[2]:i?(this.saveFile(l+d,t,a),this.setPinheadPosition(p),[2]):this.isJson(s.file)?(f=this.environmentProperties,[4,s.components.buildComponentExportHTML()]):[3,3];case 2:return h=g.sent(),Object.keys(s.components.components).length>0&&(h=f.WRAPPER_COMPONENTS_MARK_START+h+f.WRAPPER_COMPONENTS_MARK_END),s.runtimeEditor.runtimeLoad(t,{sceneSave:!0}).then(function(e){var t=m.rebuildUserHTML(e,h),n=m.cleanupHtmlExport(t);m.saveFile(l+d,n,a),m.setPinheadPosition(p)}).catch(function(e){console.log(e.message)}),[3,4];case 3:this.saveFile(l+d,t,a),this.setPinheadPosition(p),g.label=4;case 4:return[3,6];case 5:s.runtimeEditor.runtimeLoad(t,{widgetSave:!0}).then(function(e){var t=m.rebuildUserHTML(e,"",m.EXPORTING_WIDGET),n=m.cleanupHtmlExport(t);m.saveFile(l+d,n,a),m.setPinheadPosition(p)}).catch(function(e){console.log(e.message)}),g.label=6;case 6:return[2]}})})},e.prototype.setPinheadPosition=function(e){var t=this.openFiles[this.selectedEditor];null!==e&&t&&t.runtimeEditor&&this.openFiles[this.selectedEditor].runtimeEditor.Timeline.setPinheadPosition(null,e)},e.prototype.previewStop=function(e,t){var n=$("#scene");clearTimeout(e.playAnimation),e.iframe.remove(),e.iframe=void 0,t&&(n[0].style.backgroundColor=t),n.append(this.detachedSceneHTML),o.default.rekickDomWebkitMasks(),this.detachedSceneHTML=null},e.prototype.spriteChangeState=function(e,t){var n,i;t?(n="play",i="stop"):(n="stop",i="play"),e.addClass("btn-"+n),e.removeClass("btn-"+i)},e.prototype.toggleVideoPlayback=function(e,t){for(var n=e.length,i=0;i<n;i++)t?e[i].play():e[i].pause()},e.prototype.getMaxVideoLength=function(e){for(var t=0,n=e.length,i=0;i<n;i++)1e3*e[i].duration>t&&(t=1e3*e[i].duration);return t},e.prototype.preview=function(e,t,i){var a=this,s=this.selectedEditor;if(void 0!==s){var r=$("#preview-scene-button > .fa"),l=$("#preview-animation-button > .fa"),d=this.openFiles[s].runtimeEditor;d.iframe||this.setPinheadPosition(0),t=this.adjustSavedContent(JSON.stringify(d.scene),{boxShadowAndClasses:!0,textarea:!0});var c=JSON.parse(t),p=c.scripts;c.scripts=[];var u=$("#scene"),f=d.scene.style.backgroundColor;d.iframe?(this.spriteChangeState(l,!0),this.spriteChangeState(r,!0),a.previewStop(d,f),d.highlightSelectedEl(null,d.currentElementsSelection)):d.runtimeLoad(JSON.stringify(c)).then(function(e){var t=d.scene.animations,s=o.default.getObjects(t,"seconds").map(function(e){return parseFloat(e)}),c=Math.max.apply(Math,s);if(c>0){var h,m,g=d.scene.sceneSize.width,v=d.scene.sceneSize.height,b=/((<script[^<]([\s\S]*?)[^>]*<\/script>)[\s\S]*?)/g;if(a.globalEditorInfo.backend===n.default.Backends.Debug||a.globalEditorInfo.backend===n.default.Backends.Website){m=/&quot;/gi;var y="url("+window.location.origin+"/",E=/(<link\s+(?:[^>]*?\s+)?href=")([^"]*)"/g;h=e.replace(m,""),h=h.replace(/url\(/gm,y).replace(E,"$1"+window.location.origin+'/uiresources/$2"')}else m=/coui:\/\/uiresources\/editor\//gi,h=e.replace(m,"");for(var w=b.exec(h);w;)p.push(w[0]),w=b.exec(h);h=h.replace(b,"");var S=$('<iframe id="preview" sandbox="allow-same-origin allow-scripts allow-forms" width="'+g+'" height="'+v+'"></iframe>');d.clearSelectedElements();var k=$("#scene style").detach();a.detachedSceneHTML=$("#scene").html(),u[0].style.backgroundColor=null,$("#scene *").detach(),k.prependTo(u),u.append(S),a.spriteChangeState(l,!1),a.spriteChangeState(r,!1),S.ready(function(){var e=document.getElementById("preview").contentWindow,t=S.contents();t.find("html").css("overflow","hidden").append(h);var n=t.find("video");d.evalScripts(e,p),d.displayVideos(n),d.iframe=S}),d.Timeline.animatePinhead(c,i),i===n.default.animationPreviewType.preview&&(d.playAnimation=setTimeout(function(){a.previewStop(d,f),a.spriteChangeState(l,!0),a.spriteChangeState(r,!0),d.highlightSelectedEl(null,d.currentElementsSelection)},c))}})}else console.error("File id for "+e+" cannot be found!")},e.prototype.saveFile=function(e,t,i,a){var s=this;if(this.EXPORTING_WIDGET){var r=o.default.getFileAndPath(e).filename;this.onExportWidget(r,t).then(function(){return s.openFiles[s.selectedEditor].runtimeEditor._initAssetsKendoToolbar()})}else{if(this.openFiles[i].tab.pendingSave)return;this.openFiles[i].tab.pendingSave=!0,!0===this.autoReload&&this._reload(this.autoReloadCallback),this.onsave&&a!==n.default.extensions.component&&this.onsave(e,t)}},e.prototype.onSaveCompleted=function(e,n){var i=this.getIdForFile(e);if(void 0!==i){var o="editor"+i;if(this.openFiles[o].tab.pendingSave=!1,this.tabEdited(!1,o),e!==n&&this.renameTab(e,n),this.openFiles[o].tab.state===t.pendingClose){this.openFiles[o].tab.state=t.safelyClosable;var a="tab"+i;w2ui.tabs.animateClose(a)}}},e.prototype._reload=function(e){this.onreload&&this.onreload(e)},e.prototype.isItPublishPage=function(e){return e.indexOf(this.environmentProperties.ORIGINAL_SOURCE_SCENE_PATH)>-1&&e.indexOf(this.environmentProperties.ORIGINAL_SOURCE_SCENE_PATH_END)>-1},e.prototype.getOriginSceneUrl=function(e){var t=/<!-- Original scene path -->([\s\S]*)<!-- Original scene path end -->/;if(t.exec(e))return t.exec(e)[1].replace(/<!--([\s\S]*?)-->/gi,"$1").trim();console.error("there is no comment marks")},e.prototype.getFileEditorProps=function(e,t){var n=e.exec(t),i="";return n&&(i=n[0].match(/"(.*)"/)[1]),i},e.prototype.changeEngineEnv=function(e){this.preferences.couiEnvironment=e,this.savePreferences(),this._isExitingEditor=!0,engine.trigger("AboutToClose")},e.prototype.savePreferences=function(){engine.call("prefs.set","preferences",this.preferences),engine.call("prefs.save")},e.prototype.showEnvironmentWarning=function(e,t){var n=this;vex.dialog.confirm({message:"You are running the Coherent Editor in a "+t+" environment, but the file that you are trying to open has been created in "+e+" environment. Would you like to start the editor in "+e+" environment? ",contentClassName:"modal-about",callback:function(t){delete n.openFiles[n.selectedEditor],t&&n.changeEngineEnv(e)}})},e.prototype.compareSettings=function(e,t){var i={EDITOR_VERSION:n.default.EDITOR_VERSION,couiEnvironment:n.default.couiEnvironment},o=this.getFileEditorProps(i[e],t);o&&o!==this.preferences[e]&&this.showEnvironmentWarning(o,this.preferences[e])},e.prototype.openFile=function(e,t){var i=/\/*([^/]*\.([^.]*))$/.exec(t),a=i[i.length-1],s=t.replace(/[^\/\\]*$/,""),r=s;switch("widgets"===o.default.rootFolder(s)&&(s=s.split(/[\/\\]/).slice(1).join("/")),a){case"js":a=n.default.extensions.js;break;case"css":a=n.default.extensions.css;break;case"html":a=n.default.extensions.html;break;case"component":a=n.default.extensions.component}var l=t.replace(/^.*[\\\/]/,""),d=o.default.openPathHandler(e,s);if(a===n.default.extensions.html||a===n.default.extensions.component)if(this.usesSceneEditor(e)||a===n.default.extensions.component){var c=this.getFileEditorProps(n.default.couiEnvironment,e)||null;if(this._addRuntimeEditor(d,l,a,s),this.compareSettings("couiEnvironment",e),this.$wrapperCodeEditor.hide(),c&&c!==this.preferences.couiEnvironment&&a!==n.default.extensions.component)return void document.body.dispatchEvent(new Event("editorLoaded"))}else this._addFileContent(e,l,a);else this._addFileContent(e,l,a);document.body.dispatchEvent(new CustomEvent("coui.tab.change")),this.selectedEditor="editor"+this.fileId,this.openFiles[this.selectedEditor].tab.originalFullPath=r,this._addTab(l,s),this.fileId++,this.PENDING_WIDGET_LOAD&&(this.openFiles[this.selectedEditor].tab.tabWidgetState.editWidget=!0,this.PENDING_WIDGET_LOAD=!1)},e.prototype.forceClose=function(e){this.tabEdited(!1,e);var t=e.replace("editor","tab");w2ui.tabs.animateClose(t)},e.prototype.closeTabsInOrder=function(e){var t=this.selectedEditor;if(e&&(t=e.replace("tab","editor")),this._isClosingInOrder=!0,null===this.__mainSceneIdToBeClosed){this.__mainSceneIdToBeClosed=t;var n=this.openFiles[t].components.state.opened[0],i=$("#"+t),o=n.replace("editor","tab");return this.focusFileOnClose(i,o),void w2ui.tabs.animateClose(o)}if(t=this.__mainSceneIdToBeClosed,0!==this.openFiles[t].components.state.opened.length){var a=w2ui.tabs.tabs[this._getActiveTabIndex()];w2ui.tabs.animateClose(a.id)}else{this._isClosingInOrder=!1,this.__mainSceneIdToBeClosed=null;var s=t.replace("editor","tab");this.openFiles[t].tab.filename,this.openFiles[t].file;window.requestAnimationFrame(function(){w2ui.tabs.animateClose(s)})}},e.prototype.closeAllTabs=function(){if(0!==w2ui.tabs.tabs.length){this._isClosingAllTabs=!0;var e=w2ui.tabs.tabs[this._getActiveTabIndex()];w2ui.tabs.animateClose(e.id)}else this.oncloseEditor()},e.prototype.focusFile=function(e){w2ui.tabs.click("tab"+this.getIdForFile(e))},e.prototype.focusCUIFile=function(e){var t=e.replace("editor","");w2ui.tabs.click("tab"+t)},e.prototype.getSceneFileAndPath=function(e){return{path:this.openFiles[e].tab.originalFullPath,filename:this.openFiles[e].tab.filename}},e.prototype.sceneExist=function(e){for(var t in this.openFiles){var n=this.openFiles[t].tab.originalFullPath,i=this.openFiles[t].tab.filename,o=n?n.replace(/\\/g,"/"):"";if(i.endsWith(".component")){for(var a=this.openFiles[this.selectedEditor].components.state.opened,s=0;s<a.length;s++)if(this.openFiles[a[s]].tab.filename===e)return!0}else if(o+i===e)return!0}return!1},e.prototype.getIdForFile=function(e){var t=this;for(var n in t.openFiles){var i=this.getSceneFileAndPath(n).path.replace(/\\/g,"/"),o=this.getSceneFileAndPath(n).filename.replace(/\\/g,"/"),a=e.replace(/\\/g,"/");if("widgets/"===i&&o===a||i+o===a)return~~n.replace("editor","")}},e.prototype.renameTab=function(e,t){var n=this.getIdForFile(e);if(void 0!==n){var i="editor"+n;this.openFiles[i].tab.filename=t;var o=this.openFiles[i].runtimeEditor;o&&o.setOpenedFile(t);for(var a=w2ui.tabs.tabs,s=0;s<a.length;s++)if(a[s]["data-id"]===n){a[s].caption=a[s].text=t,w2ui.tabs.refresh("tab"+n);break}}},e.prototype._createTabData=function(e,n){return{filePath:"",filename:e,fileExtension:n,state:t.open,pendingSave:!1,tabWidgetState:{importedWidget:!1,editWidget:!1,instanceOf:null,createNewWidget:!1},scrollIndex:{rightPanel:0,assetLibrary:0},assetsLibraryStates:{image:{expanded:!0},video:{expanded:!0},widget:{expanded:!0},script:{expanded:!0},style:{expanded:!0},font:{expanded:!0}},snapOn:!1}},e.prototype._addFileContent=function(e,t,n){var i=this;$(".editor").hide(),"string"!=typeof e&&(e=e.toString());var o="editor"+this.fileId,a=document.createElement("pre");a.id=o,a.className="editor",a.dataset.id=this.fileId,this.$wrapperFilesEl.append(a),this.openFiles[o]={},this.openFiles[o].file=ace.edit(a),this.openFiles[o].file.setTheme("ace/theme/twilight"),this.openFiles[o].file.getSession().setMode("ace/mode/"+n),this.openFiles[o].file.insert(e);var s=this.openFiles[o].file.getSession();s.getUndoManager().reset(),s.on("change",function(){i.tabEdited(!0)}),this.openFiles[o].file.valueOf=function(){return this.getValue()}.bind(this.openFiles[o].file),this.openFiles[o].tab=this._createTabData(t,n),a.style.display="block"},e.prototype._addRuntimeEditor=function(e,t,n,i){var o=this.isJson(e)?JSON.parse(e):{},a="editor"+this.fileId;this.openFiles[a]={},this.openFiles[a].createdNow=o.createdNow||!1,this.openFiles[a].file=e,this.openFiles[a].tab=this._createTabData(t,n),this.openFiles[a].tab.filePath=i,this.openFiles[a].pendingRebuild=!1,this.openFiles[a].widgetTypesCounter={},this.openFiles[a].widgetClassCounter={},this.openFiles[a].components=new l.default,this.selectedEditor=a,this.isJson(e)||this.openFiles[a].components.load(e)},e.prototype._addTab=function(e,t){w2ui.tabs.add({id:"tab"+this.fileId,"data-id":this.fileId,path:t||"",caption:e,closable:!0}),w2ui.tabs.click("tab"+this.fileId),this._initTabsTooltip(this.fileId,e)},e.prototype._initTabsTooltip=function(e,t){function n(){var t=i.openFiles["editor"+e].tab.tabWidgetState.instanceOf,n=i.openFiles[t].tab.filePath||"",o=i.openFiles[t].tab.filename;$("#tabs_tabs_tab_tab"+e).append('<span class="tab-tooltip">belongs&nbsp;to:&nbsp;'+n+o+"</span>"),$("#tabs_tabs_tab_tab"+e).hover(function(){$(this).find(".tab-tooltip").show()},function(){$(this).find(".tab-tooltip").hide()})}var i=this;t.endsWith(".component")&&(null!==this.openFiles["editor"+e].tab.tabWidgetState.instanceOf?n():($("body").off("__componentInstanceSet"),$("body").on("__componentInstanceSet",function(){n()})))},e.prototype._getCurrentFileId=function(){return document.querySelector('.editor[style*="display: block"]').id},e.prototype._displayEditMenu=function(){System.import("lib/hbs/editing_menu.hbs!text").then(function(e){$("#edit-menu").append(e)})},e.prototype._displayMenu=function(){var e=this;$(".btn-new-file").off("click"),$(".btn-new-file").on("click",function(){$(window).trigger("createNewScene")}),$(".btn-open-file").off("click"),$(".btn-open-file").on("click",function(){e.onopen()}),$(".btn-publish-file").off("click"),$(".btn-publish-file").on("click",function(){var t=e.openFiles[e.selectedEditor];t&&t.runtimeEditor.publishScene()}),$(".btn-save-file").off("click"),$(".btn-save-file").on("click",function(){var t=e.openFiles[e.selectedEditor];if(t){var n=t.tab.filename,i=t.file.valueOf();e.save(n,i)}}),$(".btn-quit-file").off("click"),$(".btn-quit-file").on("click",function(){engine.trigger("AboutToClose")}),$(".btn-pref-file").off("click"),$(".btn-pref-file").on("click",function(){e.adjustPreferences()}),$(".btn-documentation").on("click",function(t){t.preventDefault(),e.onLaunchUrl(n.default.Links.documentation)}),$(".btn-tutorials").on("click",function(t){t.preventDefault(),e.onLaunchUrl(n.default.Links.tutorials)}),$(".btn-community-forums").on("click",function(t){t.preventDefault(),e.onLaunchUrl(n.default.Links.communityForum)}),$(".btn-editor-roadmap").on("click",function(t){t.preventDefault(),e.onLaunchUrl(n.default.Links.roadmap)}),$(".bnt-shortcut").on("click",e.onshortcut),$(".btn-about").on("click",e.onabout.bind(e))},e.prototype.onshortcut=function(){System.import("lib/hbs/shortcuts.hbs!text").then(function(e){vex.dialog.open({contentClassName:"modal-shortcuts",message:"Keyboard Shortcuts",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Close"})],afterOpen:function(t){t.append(e)}})})},e.prototype.onabout=function(){var e=this;vex.dialog.open({contentClassName:"modal-about version",message:"About",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok"})],afterOpen:function(t){var n=e.EDITOR_VERSION.join(".");t.append("Coherent Editor version: "+n)}})},e.prototype.onundo=function(){var e=this.openFiles[this.selectedEditor];e&&(e.runtimeEditor?e.runtimeEditor.undoRedoScene("undo"):e.file.undo())},e.prototype.onredo=function(){var e=this.openFiles[this.selectedEditor];e&&(e.runtimeEditor?e.runtimeEditor.undoRedoScene("redo"):e.file.redo())},e.prototype.delete=function(){var e=this.openFiles[this.selectedEditor];e&&e.runtimeEditor.removeMultipleWidgets()},e.prototype._displayToolbar=function(){var e=this;$("#toolbar-code-editor").w2toolbar({name:"toolbar",items:[{type:"button",id:"save-file",caption:"Save",icon:"fa fa-save"},{type:"break",id:"break1"},{type:"button",id:"undo",caption:"Undo",icon:"fa fa-undo"}],onClick:function(t){var n;switch(t.target){case"open-file":e.openFile("Pehso","coherent_view_1.css");break;case"save-file":n=e._getCurrentFileId(),e.save(e.openFiles[n].tab.filename,e.openFiles[n].file.valueOf());break;case"reload-file":e._reload(e.openFiles[n].tab.filename);break;case"auto-reload":!0!==t.item.checked?e.autoReload=!0:e.autoReload=!1;break;case"undo":n=e._getCurrentFileId(),e.openFiles[n].file.undo()}}})},e.prototype.kendoDestroyEvents=function(){var e=$("#horizontal-timeline-splitter"),t=$("#horizontal-inner"),n=$("#vertical"),i=$("#horizontal"),o=$("#animation-toolbar");o.length>0&&o.data("kendoToolBar")&&o.data("kendoToolBar").destroy(),e.length>0&&e.data("kendoSplitter")&&e.data("kendoSplitter").destroy(),t.length>0&&t.data("kendoSplitter")&&t.data("kendoSplitter").destroy(),n.length>0&&n.data("kendoSplitter")&&n.data("kendoSplitter").destroy(),i.length>0&&i.data("kendoSplitter")&&i.data("kendoSplitter").destroy();var a=$("#borderColor-picker"),s=$("#background-picker"),r=$("#boxShadow-picker"),l=$("#color-picker");a.length>0&&a.remove(),s.length>0&&s.remove(),r.length>0&&r.remove(),l.length>0&&l.remove();var d=$("#left-pane select");d.length>0&&d.remove();var c=$("#create-element-tabs");c.length>0&&c.remove();var p=$(".dragging-point");p.length>0&&(p.removeData("kendoDraggable"),p.removeData("role"),p.unbind("mousedown"),p.unbind("selectstart"),p.remove())},e.prototype.niceScrollDestroyEvents=function(){$(".info-widgets").length>0&&$(".info-widgets").remove()},e.prototype.initRuntimeEditorHtml=function(e){var t=this;return this.kendoDestroyEvents(),this.niceScrollDestroyEvents(),Promise.all([System.import("lib/hbs/runtime_editor_wrapper.hbs!text"),System.import("lib/animations/hbs/timeline.hbs!text")]).then(function(n){var i=n[0],o=n[1],a=t.Handlebars.compile(i),s=t.Handlebars.compile(o);t.$wrapperRuntimeEditor.html(a),$(".animations-panel").html(s),t.$wrapperRuntimeEditor.find(".runtime-editor").attr("id",e),$("#horizontal-timeline-splitter").kendoSplitter({panes:[{collapsible:!1,min:"380px",max:"500px",size:"400px"},{collapsible:!1}],resize:function(){var e=$(this.element[0]),n=$("#middle-pane").height();e.height(n),e.find(".k-splitbar").height(n),e.find(".info-section").height(n),$("#middle-pane").hide().show(0),t.resizeTimelineVertical()}})})},e.prototype.createRuntimeEditor=function(e,t,a){var s,r=this;System.config({paths:{when:"vendor/when/when.js"}}),System.import("./lib/runtime_editor").then(function(l){s=new l.default;var d=r.openFiles[a];d.runtimeEditor=s;var c=JSON.parse(localStorage.getItem(a));null!==c?(d.undo=c[a].undo,d.redo=c[a].redo):(d.undo=[],d.redo=[]),r.globalEditorInfo.backend!==n.default.Backends.Debug||r.globalEditorInfo.backend!==n.default.Backends.Website?(s.init(e,t,a),s.setOpenedFile(d.tab.filename)):s.init(e,t,a),r.initScenePanZoom(s),r.initKendoSplitter(),r.initTimelineScroll(),r.initKendoToolbar(s),r.initRightPanelItem(s),r.initEditingEventHandlers(s),r.initSceneEventHandlers(s),r.widgetEditingHandlers(),i.default.attachkeyHandlersRuntimeEditor(s),$("#horizontal-timeline-splitter").css("transform","rotate(360deg)"),s._sceneActionState.initialLoad=!1,s.exportScene(),r.assets.widget=[],r.listDirectory("widgets","(.html)",!1).then(function(e){r.updateSceneAssets(e),s._initAssetsKendoToolbar()});var p=r.openFiles[r.selectedEditor].tab.filePath;if(engine.call("SetCurrentSceneURL",p),r.classNamesCount+=o.default.numKeys(r.openFiles[r.selectedEditor].runtimeEditor.scene.animationClasses),r.missingWidgets.length>0&&!r.PENDING_WIDGET_EXPORT){var u="Could not load: <br />";r.missingWidgets.map(function(e){u+=e+" <br />"}),$("#coui-editor").trigger("vexFlashMessage",[u]),r.missingWidgets=[],r.PENDING_WIDGET_EXPORT=!1}window.requestAnimationFrame(function(){document.body.dispatchEvent(new Event("editorLoaded"))})})},e.prototype.initVexFlashMessages=function(){$("#coui-editor").on("vexFlashMessage",function(e,t,i){void 0===i&&(i=!1);var o=t||n.default.Messages.duplicateAnimationsTabToTab,a=vex.dialog.open({closeOnOverlayClick:!0,contentClassName:"modal-about",message:o,unsafeContent:"html-escape",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok",click:function(){a.data().vex.value=!1,vex.close(a.data().vex.id)}})],afterOpen:function(){i&&setTimeout(function(){a.data().vex&&vex.close(a.data().vex.id)},3e3)}})})},e.prototype.importHtmlTemplate=function(e){return(void 0===e.content&&this.globalEditorInfo.backend===n.default.Backends.Standalone||this.globalEditorInfo.backend===n.default.Backends.Unreal?e.cloneNode(!0):document.importNode(e.content,!0)).firstElementChild},e.prototype.checkComponentNameDuplication=function(e){var t=this.openFiles[this.selectedEditor].components.components;for(var n in t){var i=n;if(console.log(e,i),i===e)return!0}return!1},e.prototype.checkWidgetNameDuplication=function(e){return this.listDirectory("widgets","(.html)",!1).then(function(t){for(var n=0;n<t.length;n++){var i=t[n].url.split("\\")[1];if(console.log(e,i),i===e)return!0}return!1})},e.prototype.initExportWidgetHandler=function(){var e=this.selectedEditor,t=this.openFiles[e];if(t){var i=this,a=t.runtimeEditor,s=!1,r=a.currentParentElementsSelection;r=r.filter(function(e){return null!==e});for(var l=0;l<r.length;l++)if(a.isWidget(r[l])||!a.isTopLevel(r[l])){s=!0;break}if(r.length>=1&&!s)var d=vex.dialog.open({closeOnOverlayClick:!0,contentClassName:"modal-about",message:"",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok",click:function(){function e(e){var i=$(".vex-dialog-button.vex-first").hasClass("pending-widget-name-replace");e&&!i?($(d).find(".vex-dialog-message").text(n.default.warnMessages.nameDuplication),$(".vex-dialog-button.vex-first").text("replace").addClass("pending-widget-name-replace"),$(t).one("input",function(){$(".vex-dialog-button.vex-first").text("OK").removeClass("pending-widget-name-replace"),$(d).find(".vex-dialog-message").text("")}),event.preventDefault()):-1!==r.search(a)?($(d).find(".vex-dialog-message").text("Invalid widget name! The following characters : \\\"' ,/.:|&!\\n\\r\\t@#(){}[]=;^%$`~ are not supported in widget names!"),t.value="",event.preventDefault()):0===r.trim().length?($(d).find(".vex-dialog-message").text("Invalid widget name."),t.value="",event.preventDefault()):o.default.validateId(r)?(d.data().vex.value=!1,vex.close(d.data().vex.id)):($(d).find(".vex-dialog-message").text(n.default.warnMessages.idValidationWarning("widget name")),t.value="",event.preventDefault())}s=!1;var t=document.getElementById("give-widget-name"),a=/(\/|\$|\%|\^|\;|\=|\'|\|\,|\.|\&|\!|\\n|\\r|\\t|\@|\#|\(|\)|\{|\}|\[|\]|\`|<|>|:|"|\||\\|\?|\~|\*)/g,r=t.value;$("#export-widget-type").is(":checked")||!1?e(i.checkComponentNameDuplication(r+".component")):i.checkWidgetNameDuplication(r+".html").then(function(t){e(t)})}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){s=!0,vex.close(d.data().vex.id)}})],afterOpen:function(e){s=!0;var t=this,o=document.querySelector("#vex-create-widget"),a=i.importHtmlTemplate(o);i.globalEditorInfo.backend===n.default.Backends.Hummingbird||"Hummingbird"===i.preferences.couiEnvironment?(a.querySelector('input[type="checkbox"].convert-units-to-percent').parentNode.remove(),a.querySelector('input[type="checkbox"].export-widget-type').parentNode.remove()):(a.querySelector('input[type="checkbox"].convert-units-to-percent').id="convert-units-to-percent",a.querySelector('input[type="checkbox"].export-widget-type').id="export-widget-type");var r=a.querySelector('input[type="text"]');r.id="give-widget-name",$(r).on("keydown",function(e){e.keyCode===n.default.Keys.enter&&t.buttons[0].click()}),e.append(a)},callback:function(t){if(!s){var n=$("#convert-units-to-percent").is(":checked")||!1,o=$("#export-widget-type").is(":checked")||!1,l=document.getElementById("give-widget-name").value,d=l;o?(d+=".component",i.EXPORTING_COMPONENT=!0):(d+=".html",i.EXPORTING_WIDGET=!0,i.PENDING_WIDGET_EXPORT=!0),a.Timeline.setPinheadPosition(0,0);var c=i.cleanWidgetName(l),p=a.scene,u=$.extend(!0,{},p),f=$.extend(!0,{},i.environmentProperties.DefaultWidget),h=u.widgets;f.id=i.generateRandomId(c),f.type="widget";for(var m=[],g=[],v=0;v<h.length;v++){var b=h[v].id;r.indexOf(b)>=0?m.push(h[v]):g.push(h[v])}f.geometry=a.getWidgetElementSelectionSize(m,n),m.length>=1?(f.children=m,p.widgets=[f]):p.widgets=m,a.createUndoRedoNewWidget(f,o),g.push(p.widgets[0]),u.widgets=g,i.openFiles[e].tab.tabWidgetState.importedWidget=!0,p.widgets[0].widgetkit=d,p.animationClasses=a.transferAnimations(u,m,d),i.openFiles[e].tab.tabWidgetState.createNewWidget=!0;var y=JSON.parse(JSON.stringify(p));y.styles=[],y.scripts=[],y.widgets=[y.widgets[0]],y.sceneEvents.sceneLoad="",y.style.backgroundColor="rgba(255, 255, 255, 0)",o?i.openFiles[e].components.create(d,JSON.stringify(y)):i.save(d,JSON.stringify(y)),o&&i.replaceContentOfOpenedComponent(d,y,e),i.handleFileContent(JSON.stringify(u),i.openFiles[e].tab.filename,e,!1,!1),i.EXPORTING_COMPONENT=!1}}});else vex.dialog.alert({contentClassName:"modal-about",message:"Invalid selection! Please select at least two top level non-widget UI elements."})}},e.prototype.replaceContentOfOpenedComponent=function(e,t,n){for(var i=0;i<this.openFiles[n].components.state.opened.length;i++){var o=this.openFiles[n].components.state.opened[i];if(this.openFiles[o].tab.filename===e)return void(this.openFiles[o].file=JSON.stringify(t))}},e.prototype.initSceneEventHandlers=function(e){var t=this;$("#right-pane").off("scroll"),$("#right-pane").on("scroll",function(t){e.tab.scrollIndex.rightPanel=$(t.target).scrollTop()}),$("#assets-bar-holder").off("scroll"),$("#assets-bar-holder").on("scroll",function(t){e.tab.scrollIndex.assetLibrary=$(t.target).scrollTop()}),$("#save-scene").off("click"),$("#save-scene").on("click",function(){var e=t.openFiles[t.selectedEditor],n=e.tab.filename;t.save(n,e.file.valueOf())}),$("#preview-animation-button").off("click"),$("#preview-animation-button").on("click",function(){var i="";i=t.openFiles[t.selectedEditor].runtimeEditor.repeatAnimation?n.default.animationPreviewType.endlessPreview:n.default.animationPreviewType.preview,e.preview(i)}),$("#prev-animation-button").off("click"),$("#prev-animation-button").on("click",function(){e.Timeline.setToPreviousKeyframe()}),$("#next-animation-button").off("click"),$("#next-animation-button").on("click",function(){e.Timeline.setToNextKeyframe()}),$("#first-animation-button").off("click"),$("#first-animation-button").on("click",function(){e.Timeline.setToFirstKeyframe()}),$("#last-animation-button").off("click"),$("#last-animation-button").on("click",function(){e.Timeline.setToLastKeyframe()}),$("#auto-keyframe-button").off("click"),$("#auto-keyframe-button").on("click",function(){$(this).toggleClass("active"),e.switchAutoKeyframe()}),$("#repeat-animation-button").off("click"),$("#repeat-animation-button").on("click",function(){$(this).toggleClass("active"),e.switchRepeatAnimation()}),$("#filter-animation-button").off("click"),$("#filter-animation-button").on("click",function(){e._sceneActionState.primaryAction="new action",t.preferences.timeline.filterTimelineWidgets?t.preferences.timeline.filterTimelineWidgets=!1:t.preferences.timeline.filterTimelineWidgets=!0,t.savePreferences(),e.Timeline.resetAllTimeline(),e.Animations.loadTimeline(e.scene.animationClasses)}),$(".animations-panel a").on("click",function(){e.blurOutTextInputs()}),$("#scene-aspect-ratio").off("change"),$("#scene-aspect-ratio").on("change",function(n){var i=n.target.value;e._setUndoRedoCommandsFill({aspectRatio:{type:e.scene.sceneSize.type}},"new action"),e.setAspectRatio(i),"aspectRatio_custom"!==i?window.requestAnimationFrame(function(){t.focusCUIFile(t.selectedEditor)}):document.querySelector("#aspect-ratio-custom").classList.remove("is-hidden")}),$("#resetZoom").off("click"),$("#resetZoom").on("click",function(){$("#scene").panzoom("setMatrix","matrix(1, 0, 0, 1, 0, 0)"),e.tab.sceneTransformMatrix=[1,0,0,1,0,0],e.changeSceneScale(1)})},e.prototype.initEditingEventHandlers=function(e){var t=this;$(".btn-undo-scene").off("click"),$(".btn-undo-scene").on("click",function(e){e.preventDefault(),t.onundo()}),$(".btn-redo-scene").off("click"),$(".btn-redo-scene").on("click",function(e){e.preventDefault(),t.onredo()}),$(".btn-copy-widgets").off("click"),$(".btn-copy-widgets").on("click",function(t){t.preventDefault(),$(this).hasClass("disabled")||(e._sceneActionState.primaryAction="new action",e.copyWidgets())}),$(".btn-paste-widgets").off("click"),$(".btn-paste-widgets").on("click",function(t){t.preventDefault(),e.cloneWidget()}),$(".btn-createWidget-scene").off("click"),$(".btn-createWidget-scene").on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||t.initExportWidgetHandler()}),$(".btn-delete-widget").off("click"),$(".btn-delete-widget").on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||t.delete()})},e.prototype.initScenePanZoom=function(e){var t,i=this,o=e.tab,a=$("#sceneScale"),s=$(".sceneZoomButton"),r=$("#top-scene-holder"),l=$("#slider-zoom-percent");o.sceneTransformMatrix?t="matrix("+o.sceneTransformMatrix.join(" ,")+")":(t="matrix(1, 0, 0, 1, 0, 0)",o.sceneTransformMatrix=[1,0,0,1,0,0]);var d=function(e,t){$(e).addClass("k-state-active"),$(t).removeClass("k-state-active")};e.sceneWrapper.panzoom("destroy"),$("#scene").panzoom("destroy");var c=$("#scene-wrapper").panzoom({disablePan:!0,startTransform:t,minScale:.3,maxScale:1.7,cursor:"default",$set:$("#scene")});$("#scene").panzoom({disablePan:!0});var p=o.sceneTransformMatrix[0];e.changeSceneScale(p),$("html").off("keydown"),$("html").on("keydown",function(t){t.which===n.default.Keys.alt&&(t.preventDefault(),e.isInPanningMode=!0,d("#pan-tool","#select-tool"),c.panzoom("option",{disablePan:!1}),$(".onoff").css("z-index",-1),i.panningCursor(!0))}),$("html").off("keyup"),$("html").on("keyup",function(t){t.which!==n.default.Keys.alt||u||(t.preventDefault(),e.isInPanningMode=!1,d("#select-tool","#pan-tool"),c.panzoom("option",{disablePan:!0}),i.panningCursor(!1),$(".onoff").css("z-index",999),o.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)}))}),$(window).off("blur"),$(window).on("blur",function(){u||(e.isInPanningMode=!1,d("#select-tool","#pan-tool"),i.panningCursor(!1),c.panzoom("option",{disablePan:!0}))}),c.parent().on("mousewheel.focal",function(t){t.preventDefault();var n=t.delta||t.originalEvent.wheelDelta,i=n?n<0:t.originalEvent.deltaY>0;c.panzoom("zoom",i,{animate:!1,increment:.1,focal:t}),o.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)});var a=o.sceneTransformMatrix[0];e.changeSceneScale(a)});var f=$("#scene-property");f.off("mousedown"),f.on("mousedown",function(){e.WidgetSelection.detachHandlers()}),f.off("mouseup mouseleave"),f.on("mouseup mouseleave",function(){e.WidgetSelection.attachHandlers()}),a.off("input change"),a.on("input change",function(t){t.preventDefault(),e._dragFlag=!1;var n={clientX:r.offset().left+r.width()/2,clientY:r.offset().top+r.height()/2},i=t.target.value;i=(i-30)/140*1.4+.3,c.panzoom("zoom",i,{disablePan:!1,focal:n}),e.changeSceneScale(i),o.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)})}),s.off("mousedown"),s.on("mousedown",function(t){t.preventDefault();var n="incrementSceneZoom"!==this.id,i={clientX:r.offset().left+r.width()/2,clientY:r.offset().top+r.height()/2};c.panzoom("zoom",n,{disablePan:!1,increment:.025+1e-4*Math.random(),focal:i}),o.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)});var a=o.sceneTransformMatrix[0];e.changeSceneScale(a)}),l.off("mousedown"),l.on("mousedown",function(){var e=$(this),t=e.val();"%"===t[t.length-1]&&e.val(t.slice(0,-1))}),l.off("blur keyup"),l.on("blur keyup",function(t){event.preventDefault();var i=$(this),a=parseFloat(i.val());if("blur"===t.type||t.keyCode===n.default.Keys.enter){var s={clientX:r.offset().left+r.width()/2,clientY:r.offset().top+r.height()/2};a>170?a=170:a<30&&(a=30),a=(a-30)/140*1.4+.3,c.panzoom("zoom",a,{disablePan:!1,focal:s}),o.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)}),t.keyCode===n.default.Keys.enter&&i.blur(),e.changeSceneScale(a)}}),o.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)})},e.prototype.initKendoSplitter=function(){var e=this;$("#horizontal").kendoSplitter({orientation:"horizontal",panes:[{resizable:!1,collapsible:!0,size:"280px"}],resize:function(){$("#left-pane").height($("#left-pane").height()+15)}}),$("#vertical").kendoSplitter({orientation:"vertical",panes:[{collapsible:!0},{collapsible:!0,min:"100px",size:"35%"}],collapse:function(t){"middle-pane"===t.pane.id&&($(".info-widgets").getNiceScroll().hide(),e.detachedAmnimationsHTML=$(".animations-panel").detach())},expand:function(t){null!==e.detachedAmnimationsHTML&&($("#middle-pane").append(e.detachedAmnimationsHTML),e.detachedAmnimationsHTML=null,e.resizeTimelineVertical(),$(".info-widgets").getNiceScroll().show())},resize:function(){$("#middle-pane").hide().show(0),$("#assets-bar .files-cont").hide().show(0),$("#horizontal-timeline-splitter").data("kendoSplitter")&&$("#horizontal-timeline-splitter").data("kendoSplitter").trigger("resize"),e.resizeTimelineVertical()}}),$("#horizontal-inner").kendoSplitter({orientation:"horizontal",panes:[{collapsible:!0},{collapsible:!0,min:"270px",size:"270px"}]}),this.resizeTimelineVertical()},e.prototype.resizeTimelineVertical=function(){var e=this.openFiles[this.selectedEditor].runtimeEditor,t=$(".timeline-wrap").height();$(".widgets-keyframes").height(t-62),$(".info-widgets").height(t-62),$(".pin-height").height(t-42),$("#assets-bar .files-cont").hide().show(0),$(".info-widgets").getNiceScroll().resize();var i=$(".scene-properties-holder").height(),o=$(".scene-hierarchy-holder").height(),a=$("#right-pane").height()-(i+o);$("#assets-bar").is(":visible")?(a=a<n.default.assetLabelsEntryHeight?n.default.assetLabelsEntryHeight:a,$(".scene-library-holder").css("height",a),$("#assets-bar").css("height",a-n.default.assetsLibraryLabelSize),$("#assets-bar-holder").css("height",a-n.default.assetLibraryPreviewSize),e&&e.virtualList.isInstantiated()&&e.virtualList.refresh()):$(".scene-library-holder").css("height",n.default.assetsLibraryLabelSize)},e.prototype.initTimelineScroll=function(){$(".info-widgets").niceScroll({cursoropacitymin:1,cursorwidth:10,cursorborder:"1px solid #262626",cursorborderradius:0,cursorcolor:"#1C1C1C"}),$(".info-widgets").scroll(function(e){var t=$(".info-widgets").scrollTop();$(".widgets-keyframes").scrollTop(t)})},e.prototype.createModalSceneEditor=function(e,t){void 0===e.scene.sceneEvents&&(e.scene.sceneEvents={sceneLoad:""});var n=e.scene.sceneEvents[t];e.createModalJsEditor(t,"sceneEvents",n)},e.prototype.initKendoToolbar=function(e){var t=this,i=function(n){"pan-tool"===n.id?e.isInPanningMode=!0:"select-tool"===n.id&&(e.isInPanningMode=!1),u=e.isInPanningMode,t.panningCursor(e.isInPanningMode),e.scenePanning()};$(".k-list-container").remove(),$("#animation-toolbar").kendoToolBar({items:[{type:"button",spriteCssClass:"btn-first-keyframe",id:"first-animation-button"},{type:"button",spriteCssClass:"btn-previous-keyframe",id:"prev-animation-button"},{type:"button",spriteCssClass:"fa btn-play",id:"preview-animation-button"},{type:"button",spriteCssClass:"btn-next-keyframe",id:"next-animation-button"},{type:"button",spriteCssClass:"btn-last-keyframe",id:"last-animation-button"},{type:"button",spriteCssClass:"ic-autokeyframe",id:"auto-keyframe-button",class:"btn-autokeyframe",togglable:!0},{type:"button",spriteCssClass:"ic-repeat-animation",id:"repeat-animation-button",class:"btn-repeat-animation",togglable:!0},{type:"button",spriteCssClass:"fa fa-filter btn-filter-animation",id:"filter-animation-button",class:"btn-filter-animation",togglable:!0,selected:t.preferences.timeline.filterTimelineWidgets}]}),$("#toolbar").kendoToolBar({items:[{type:"button",spriteCssClass:"fa fa-file",id:"new-file",click:function(){$(window).trigger("createNewScene")}},{},{type:"button",spriteCssClass:"fa fa-folder-open",id:"open-file",click:function(){t.onopen()}},{},{type:"button",spriteCssClass:"fa fa-save",id:"save-scene"},{type:"button",spriteCssClass:"fa fa-external-link",id:"publish-scene",click:function(){e.publishScene()}},{type:"button",spriteCssClass:"fa fa-undo",id:"undo-scene",click:function(){e.undoRedoScene("undo"),t.autoTriggerUndoRedo("undo")}},{},{type:"button",spriteCssClass:"fa fa-repeat",id:"redo-scene",click:function(){e.undoRedoScene("redo"),t.autoTriggerUndoRedo("redo")}},{type:"button",spriteCssClass:"fa fa-magnet",id:"snap-scene",togglable:!0,selected:t.openFiles[t.selectedEditor].tab.snapOn,toggle:function(e){var n=t.openFiles[t.selectedEditor].tab.snapOn;t.openFiles[t.selectedEditor].tab.snapOn=!n,$(e.target).toggleClass("k-state-active",!n)}},{type:"button",spriteCssClass:"fa fa-mouse-pointer",id:"select-tool",togglable:!0,group:"scene-buttons",selected:!0,toggle:i},{type:"button",spriteCssClass:"fa fa-hand-paper-o",id:"pan-tool",togglable:!0,group:"scene-buttons",toggle:i},{type:"button",imageUrl:"./img/resetZoom.png",id:"resetZoom"},{type:"button",imageUrl:"./img/help.png",id:"help",click:function(){t.onLaunchUrl(n.default.Links.documentation)}}]}),t.setToolbarTitles()},e.prototype.initRightPanelItem=function(e){this.initKendoDropDownsInRightPane(),this.initKendoToolbarsInRightPane(e),this.initInputSupportForGTInRightPane(e),this.initSceneBackgroundColorPicker(e)},e.prototype.initKendoDropDownsInRightPane=function(){return $("#right-pane select").kendoDropDownList({animation:!1}),this},e.prototype.initKendoToolbarsInRightPane=function(e){var t=this;$("#scene-events").kendoToolBar({items:[{type:"splitButton",overflow:"never",text:"Events",id:"scene-events-split-button",menuButtons:[{text:"on scene load",id:"sceneLoad",click:function(n){t.createModalSceneEditor(e,n.id)}}]}]})},e.prototype.initInputSupportForGTInRightPane=function(e){e.inputNumbersFocusInOutHandler("right-pane")},e.prototype.initSceneBackgroundColorPicker=function(e){$("#scene-background-picker").kendoColorPicker({buttons:!1,value:e.scene.getStyleProperty("backgroundColor"),opacity:!0,close:function(t){e.setSceneStyleProperty("backgroundColor",t.sender.element.val())},select:function(t){e.scene.applyStyleProperty("backgroundColor",t.sender.element.val())}})},e.prototype.autoTriggerUndoRedo=function(e){var t=this.openFiles[this.selectedEditor],n=t.runtimeEditor,i=t.redo[0],o=t.undo[0]&&t.undo[0][0].deleteComponent;if(i&&(i[0].deleteElement&&i[0].deleteElement.createWidget.isNewWidget||i[0].deleteComponent)&&n.undoRedoScene(e),i&&i[0].createElement&&o){var a=i[0].createElement.deleteWidget;a.widgetkit&&a.widgetkit.endsWith(".component")&&n.undoRedoScene(e)}},e.prototype.createNewScene=function(e,t){var i=o.default.getFileAndPath(t).path;engine.call("SetCurrentSceneURL",i);var a=t,s=Object.keys(this.openFiles).length,r=$.extend(!0,{},n.default.newScene);if(e.createdNow=!0,e&&$.extend(!0,r,e),s>0)for(var l in this.openFiles){var c=this.getSceneFileAndPath(l),p=c.path,u=c.filename;p.replace(/\//g,"\\")+u===t&&this.clearTab(l,event)}this.openFile(JSON.stringify(r),a),$("#loader-wrapper").show(),this.save(a,JSON.stringify(r),!0),d++,this.openFiles[this.selectedEditor].tab.sceneID=this.fileId,this.openFiles[this.selectedEditor].tab.pendingSave=!1},e.prototype.createNewTestScene=function(e,t){var i="";i=e?e+".html":"*new"+d+".html";var o=$.extend(!0,{},n.default.newScene);t&&$.extend(!0,o,t),this.openFile(JSON.stringify(o),i),d++},e.prototype.generateRandomId=function(e){return this.incrementWidgetTypesCounter(e),e+this.getWidgetCounterForType(e)},e.prototype.generateClassName=function(){var e=this.openFiles[this.selectedEditor],t=n.default.animationClassPrefix+"animation"+this.classNamesCount++,i=e.tab.filename.endsWith(".component");if(e.runtimeEditor.scene.animationClasses[t])return this.generateClassName();for(var o=0;o<e.components.state.opened.length;o++){var a=e.components.state.opened[o];if(this.openFiles[a].runtimeEditor.scene.animationClasses[t])return this.generateClassName()}if(i){var s=e.tab.tabWidgetState.instanceOf,r=this.openFiles[s];if(JSON.parse(r.file).animationClasses[t])return this.generateClassName()}return t},e.prototype.incrementWidgetTypesCounter=function(e){var t=this.openFiles[this.selectedEditor];t.widgetTypesCounter=t.widgetTypesCounter||{},t.widgetTypesCounter[e]||(t.widgetTypesCounter[e]=0);var n=t.widgetTypesCounter[e]+1,i=t.runtimeEditor;if(i)for(;void 0!==i.mappedWidgets[e+n];)t.widgetTypesCounter[e]++,n=t.widgetTypesCounter[e]+1;t.widgetTypesCounter[e]++},e.prototype.getWidgetCounterForType=function(e){return this.openFiles[this.selectedEditor].widgetTypesCounter[e]},e.prototype.cleanupImportedHTML=function(e){var t=/<!-- Register Components Start -->([\s\S]*?)<!-- Register Components End -->/.exec(e);null!==t&&(e=e.replace(t[0],""));var n=/<!-- Wrapper Components Start -->([\s\S]*?)<!-- Wrapper Components End -->/.exec(e);return null!==n&&(e=e.replace(n[0],"")),e},e.prototype.handleFileContent=function(e,t,n,i,o){var s=this,r=t.endsWith(".component"),l=$.Deferred();void 0!==this.openFiles[this.selectedEditor].tab.originalHTML||this.isJson(e)||r||(this.openFiles[this.selectedEditor].tab.originalHTML=this.cleanupImportedHTML(e.valueOf())),i=i||!1,o=o||!1;var d,c,p,u=this.photoshopExport(e),f=/\/\* CSS Animations Start \*\/([\s\S]*?)\/\* CSS Animations End \*\//,h=/\/\* Aspect Ratio Start \*\/([\s\S]*)\/\* Aspect Ratio End \*\//,m=/\/\* Scene Properties Start \*\/([\s\S]*)\/\* Scene Properties End \*\//,g=/<body>([\s\S]*)<\/body>/;if(u){var v=/<!-- Save for Web Slices \([\s\S]+\) -->([\s\S]+)<!-- End Save for Web Slices -->/,b=/<!-- Save for Web Styles \([\s\S]+\) -->([\s\S]+)<!-- End Save for Web Styles -->/;v.exec(e.valueOf())&&b.exec(e.valueOf())&&(d=v.exec(e.valueOf())[1],c=b.exec(e.valueOf())[1],this.addTempStyleHolder(c))}else g.exec(e.valueOf())&&(d=g.exec(e.valueOf())[0]);var y={};if(void 0===d){if(y=JSON.parse(e.valueOf()),this.openFiles[this.selectedEditor].tab.tabWidgetState.importedWidget&&o){var E=/.html/,w=y.widgets[0].widgetkit.replace(E,"");w=this.cleanWidgetName(w);var S=this.generateRandomId(w);y.widgets[0].id=S}}else if(u)y=this.buildHTML(d);else{var k=/<!-- Coherent Editor Start -->([\s\S]*)<!-- Coherent Editor End -->/.exec(e.valueOf())[1],x=/<style id="coui_font_faces">([\s\S]*?)<\/style>/.exec(e.valueOf()),C=void 0;x&&(C=x[1]);var T=k.split("<body>")[1];y=this.buildHTML(T,C)}if(m.exec(e)){var F;F=(F=m.exec(e)[1]).match(/{.+}/),(F=JSON.parse(F[0])).style?(y.style=F.style,this.animationBelongsTo=F.sceneType):y.style=F}if(f.exec(e)&&(p=f.exec(e.valueOf())[1]),h.exec(e)){var _;_=(_=h.exec(e)[1]).match(/{.+}/),_=JSON.parse(_[0]),y.sceneSize=_}p&&""!==p&&(y.animationClasses=a.default.importCss(p));var O=y.widgets[0];this.openFiles[this.selectedEditor].tab.tabWidgetState.importedWidget&&o&&(y=this.extendObj(this.openFiles[this.selectedEditor].runtimeEditor.scene,y));var N=this.openFiles[this.selectedEditor];if(y.widgets&&this.checkWidget(y.widgets)&&!i&&!r)y=this.updateWidget(y),N.tab.tabWidgetState.importedWidget=!0,y instanceof Promise?y.then(function(e){s.animationBackwardsCompatibility(e.widgets),s.loopAnimationsIds(e.animationClasses).then(function(i){e.animationClasses=i,o&&N.runtimeEditor.saveUndoRedoAfterCreateElement(O.id,O),e.animations={},s.rebuildRuntimeEditor(e,i,t,n),l.resolve()})}):(this.animationBackwardsCompatibility(y.widgets),y.animations={},this.rebuildRuntimeEditor(y,y.animationClasses,t,n),l.resolve());else{if(i&&!o)return y;this.animationBackwardsCompatibility(y.widgets),y.animations={},this.rebuildRuntimeEditor(y,y.animationClasses,t,n),l.resolve()}return l.promise()},e.prototype.loopWidgetChildAndGenerateIds=function(e){function t(e){for(var i=0;i<e.length;i++)e[i].id=n.generateRandomId(e[i].type),e[i].children.length>0&&t(e[i].children)}var n=this,i=$.extend(!0,{},e);return t(i.children),i},e.prototype.animationBackwardsCompatibility=function(e){for(var t=this.animationsBackwardsCompatibility.idsToClasses,n=t.length,i=0;i<n;i++)for(var a=0;a<e.length;a++)e[a].id===t[i]&&(o.default.doesClassNameExist(e[a].className,t[i])||(e[a].className=t[i])),e[a].children.length>0&&this.animationBackwardsCompatibility(e[a].children)},e.prototype.loopAnimationsIds=function(e){var t=this.openFiles[this.selectedEditor].runtimeEditor;if(!t)return new Promise(function(t){return t(e||{})});var i=t.scene.animationClasses,o=[];if(this.openFiles[this.selectedEditor].runtimeEditor){for(var a in i){var s=e[a];if(s&&s.belongTo!==i[a].belongTo){!function(){var e=new Promise(function(e){var t=vex.dialog.confirm({closeOnOverlayClick:!0,contentClassName:"modal-about",message:n.default.Messages.overwriteWidgetAnimations,buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Yes",click:function(){vex.close(t.data().vex.id),e("yes")}}),$.extend({},vex.dialog.buttons.NO,{text:"No",click:function(){vex.close(t.data().vex.id),e("no")}})]})});o.push(e)}();break}}o.push(new Promise(function(e){return e("yes")}))}return Promise.all(o).then(function(t){return"yes"===t[0]?$.extend(!0,i,e):i})},e.prototype.cleanupHtmlExport=function(e){var t,i=this,a=/-webkit-transform/g,s=e.match(/<script class="global-events">[\s\S]*\/script>/)[0],r=e.split(s);t=this.globalEditorInfo.backend===n.default.Backends.Unreal?/coui:\/\/editor\//gi:/coui:\/\/uiresources\/editor\//gi;var l=r[0].replace(a,"transform").replace(t,""),d=this.openFiles[this.selectedEditor].tab.filePath;return l=l.replace(/url\((.*?)\)/gi,function(e,t){if(e.match(/&quot;/))return e;var n='"'===t[0]?'"':"'";return"url("+n+i.handleRelativePath(t)+n+")"}).replace(/src="([coui:\/\/]|.*?)"/gi,function(e,t){var n=t;if("js"!==t.split(".").pop())n=i.handleImageCouiPath(t);else{var a=o.default.getFileAndPath(t).path,s=o.default.getFileAndPath(t).filename;n=o.default.externalFilePathHandler(a,d)+s}return'src="'+n+'"'}).replace(/<link.*href="([coui:\/\/]|.*?)">/gi,function(e,t){var n=o.default.getFileAndPath(t).path,i=o.default.getFileAndPath(t).filename;return'<link rel="stylesheet" type="text/css" class="styles" href="'+(o.default.externalFilePathHandler(n,d)+i)+'">'}).replace(/background-position: initial initial/gi,function(e,t){return"background-position: initial"}).replace(/-webkit-blend-mode/gi,function(e,t){return"mix-blend-mode"}).replace(/font-family: initial;/g,"").replace(/(-webkit-)?mask-size: (.*?);/gi,function(e){return o.default.transformMaskSize(e)}),[l,s,r[1]].join("")},e.prototype.handleImageCouiPath=function(e){var t=this.openFiles[this.selectedEditor].tab.filePath.replace(/\\/g,"/"),n=e.match(/coui:\/\//),i=o.default.getFileAndPath(e),a=i.path,s=i.filename,r=new RegExp("^"+t),l="";if(n&&(a=a.replace(/coui:\/\/uiresources\//,"")),e.match(r))l=a.replace(t,"").replace(/[^\/\\]*$/,"");else for(var d=t.split("/"),c=a.split("/"),p=c.length,u=0;u<p;u++){var f=0;if(d[u]!==c[u]){l="../".repeat(f||d.length-1)+c.join("/");break}d[u]===c[u]&&(c=c.slice(u+1),d=d.slice(u+1),f++)}return l+s},e.prototype.handleRelativePath=function(e){var t=e.replace(/'|"/g,""),n=this.openFiles[this.selectedEditor].tab.filePath,i=o.default.getFileAndPath(t),a=i.path,s=i.filename;return o.default.pathHandler(a,n,t)+s},e.prototype.panningCursor=function(e){var t=$(".panning");e?t.addClass("is-panning"):t.removeClass("is-panning")},e.prototype.buildJSON=function(e,t){void 0===t&&(t="");var i=[],a=e.childNodes,s=$.extend(!0,{},n.default.newScene),r=this.openFiles[this.selectedEditor].tab.filePath;this.renderStyles("imported-styles",e);for(var l in a){var d=a[l];switch(void 0!==d.localName&&null!==d.localName&&"#text"!==d.nodeName&&"SCRIPT"!==d.nodeName&&"LINK"!==d.nodeName&&i.push(d),d.className){case"global-events":s.sceneEvents.sceneLoad=d.innerText;break;case"scripts":var c=o.default.cleanUrls(d.src);s.scripts.push(o.default.assetPathHandler(c,r));break;case"styles":var p=o.default.cleanUrls(d.href);s.styles.push(o.default.assetPathHandler(p,r))}}return t&&(s.fonts=(t.match(/'.*?'/gi)||[]).map(function(e){return e.replace(/'/g,"")})),i.length&&this.buildChildNodes(i,s),s},e.prototype.renderStyles=function(e,t){var n=document.getElementById(e);if(null!==n){for(var i=n.querySelector("style").sheet.cssRules,o=0,a=i.length;o<a;o++){var s=i[o];t.querySelector(s.selectorText).style.cssText+=s.style.cssText}n.parentNode.removeChild(n)}},e.prototype.buildChildNodes=function(e,t){var n;for(var i in e)n=this.childNode(e[i]),t.widgets.push(n)},e.prototype.loopChildNodes=function(e){if(1===e.length)return this.childNode(e[0]);for(var t=[],n=0;n<=e.length-1;n++)t.push(this.childNode(e[n]));return t},e.prototype.updateWidget=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,i,o,a,s,r,l,d;return __generator(this,function(c){switch(c.label){case 0:t="",n=[],i=[],o=this,a=[];for(s in e.widgets)a.push(s);r=0,c.label=1;case 1:return r<a.length?(l=a[r],!e.widgets[l].children.length||e.widgets[l].widgetkit?[3,3]:[4,this.updateWidget(e.widgets[l].children)]):[3,6];case 2:return c.sent(),[3,5];case 3:return e.widgets[l].widgetkit?(d="",d=" "!==e.widgets[l].widgetkit?e.widgets[l].widgetkit:"test",[4,this.fetchWidget(d)]):[3,5];case 4:"missing widget"!==(t=c.sent())&&(n.push(t),i.push(l)),c.label=5;case 5:return r++,[3,1];case 6:return 0!==n.length?[2,Promise.all(n).then(function(t){for(var n=0;n<t.length;n++)"string"==typeof t[n]&&(t[n]=JSON.parse(t[n])),e.animationClasses=$.extend({},e.animationClasses,t[n].animationClasses),e.widgets[i[n]].children=t[n].widgets[0].children,e.widgets[i[n]].widgetkit.endsWith(".component")&&(e.widgets[i[n]]=o.loopWidgetChildAndGenerateIds(e.widgets[i[n]]));return e})]:[2,e]}})})},e.prototype.buildWidgetSceneObjFromHtml=function(e){return this.handleFileContent(e,"load.component",this.selectedEditor,!0,!1)},e.prototype.fetchWidget=function(e){return __awaiter(this,void 0,void 0,function(){var t,i,o,a,s,r,l,d,c,p,u,f;return __generator(this,function(h){switch(h.label){case 0:return t=this,o=new Date,s="component",r=this.openFiles[this.selectedEditor].tab.filename,l=this.openFiles[this.selectedEditor].tab.filePath.replace("widgets/","").replace("editor/selenium/scenes/GT/","").replace("editor/selenium/scenes/General/",""),e.endsWith(".html")&&(s="widget"),d=l+"widgets/"+e,"widget"!==s?[3,2]:(a=this.globalEditorInfo.backend===n.default.Backends.Standalone||this.globalEditorInfo.backend===n.default.Backends.Unreal?d+"?"+o.getTime()+"!text":"uiresources/"+d+"?"+o.getTime()+"!text",[4,this.linkCheck(d.replace(/\//g,"\\"))]);case 1:return(c=h.sent())||r===e?[2,System.import(a).then(function(e){return i=t.handleFileContent(e,t.openFiles[t.selectedEditor].tab.filename,t.selectedEditor,!0,!1)})]:(this.missingWidgets.push(d),[2,"missing widget"]);case 2:if("component"===s)return p=this.openFiles[this.selectedEditor],(u=p.components.components[e])||(u=p.file),f=t.handleFileContent(u,t.openFiles[t.selectedEditor].tab.filename,t.selectedEditor,!0,!1),[2,Promise.resolve(f)];h.label=3;case 3:return[2]}})})},e.prototype.linkCheck=function(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return[4,this.listDirectory("widgets","(.html)",!1)];case 1:return t=n.sent(),[2,t.some(function(t){return t.url===e})]}})})},e.prototype.checkWidget=function(e){for(var t in e)if(e[t].children.length&&!e[t].widgetkit)this.checkWidget(e[t].children);else if(e[t].widgetkit)return!0;return!1},e.prototype.hasId=function(e,t){return this.isJson(e.file)?o.default.hasInChildren(JSON.parse(e.file).widgets,"id",t):-1!==e.file.indexOf('id="'+t+'"')},e.prototype.toChangeId=function(e,t,n){var i=!1,o=!1;for(var a in e)if(this.isJson(e[a].file)){if(i=this.hasId(e[a],t),!e[a].createdNow)continue;n===a&&(o=this.hasId(e[a],t))}return!(i&&!o)},e.prototype.getChangeIdConditions=function(e,t){var n=!1;e&&(n=this.toChangeId(this.openFiles,e,this.selectedEditor));var i=document.getElementById(e);return{allowAdding:!i||i&&!n,applied:t[this.selectedEditor][e],editing:this.openFiles[this.selectedEditor].tab.tabWidgetState.editWidget}},e.prototype.childNode=function(e){this.widgetCount++;var t,n,i,a=[],r=$.extend(!0,{},this.environmentProperties.DefaultWidget);if(e.children.length&&((i=this.loopChildNodes(e.children))instanceof Array?a=i:a.push(i))," "!==r.type){var l="";l="IMG"===e.nodeName?"image":e.nodeName.toLowerCase(),r.widgetkit?r.type="widget":e.hasAttribute("data-type")?r.type=e.getAttribute("data-type"):r.type=l}p[this.selectedEditor]=p[this.selectedEditor]||{};var d=this.getChangeIdConditions(e.id,p);if(e.id&&d.allowAdding&&!d.applied||d.editing)r.id=e.id,p[this.selectedEditor][e.id]=e.id,this.incrementWidgetTypesCounter(r.type);else{var u;if("widget"===r.type){var f=/.html/,h=e.dataset.widgetkit.replace(f,"");h=this.cleanWidgetName(h),u=this.generateRandomId(h)}else u=this.generateRandomId(r.type);r.id=u,c[u]=e.id,p[this.selectedEditor][u]=u}r=s.default.buildWidget(r.type,r,e),t=e.dataset;for(var m in t)if("type"===m||"widgetkit"===m)r[m]=t[m]||!0;else if(o.default.isDataBindingTypes(m))this.setWidgetDataBinds(r.dataBindings,m,t[m]);else if(o.default.isEventName(m))if("engineTriggerArguments"===(n=t[m].split("("))[0]||"engineCallArguments"===n[0]||"blueprintFunction"===n[0]){var g=n[1].split(")")[0].split(",");this.setWidgetEvents(r.events,m,n,g)}else r.events[m]={javascriptFunction:t[m]};return a.length&&(r.children=a),r},e.prototype.cleanWidgetName=function(e){e.endsWith(".component")&&(e=e.replace(".component",""));var t=/[,._ ()+\-*&^!?=]/g;return e.replace(t,"_")},e.prototype.setWidgetDataBinds=function(e,t,n){e[t]={},e[t]=n},e.prototype.setWidgetEvents=function(e,t,n,i){var o=n[0];e[t]={},e[t][o]=i},e.prototype.isJson=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},e.prototype.usesSceneEditor=function(e){return this.isJson(e)||e.indexOf(this.environmentProperties.COMMENT_MARK_START)>-1&&e.indexOf(this.environmentProperties.COMMENT_MARK_END)>-1},e.prototype.photoshopExport=function(e){return this.isJson(e)||e.indexOf(this.environmentProperties.PHOTOSHOP_STYLE_COMMENT_END)>-1&&e.indexOf(this.environmentProperties.PHOTOSHOP_CONTENT_COMMENT_END)>-1},e.prototype.addTempStyleHolder=function(e){var t=document.createElement("div");t.id="imported-styles",t.innerHTML=e,document.body.appendChild(t)},e.prototype.setToolbarTitles=function(){document.getElementById("new-file").title="New file",document.getElementById("open-file").title="Open file",document.getElementById("save-scene").title="Save file",document.getElementById("undo-scene").title="Undo",document.getElementById("redo-scene").title="Redo",document.getElementById("select-tool").title="Select Tool",document.getElementById("pan-tool").title="Pan Scene",document.getElementById("resetZoom").title="Reset zoom",document.getElementById("help").title="Help"},e.prototype.extendObj=function(e,t){var n=function(e,t){var i={};for(var o in t){var a=e[o],s=t[o];"animations"===o?i[o]=$.extend(!0,a,s):a?"object"!=typeof a||s instanceof Array?s instanceof Array?([],i[o]=a.concat(s)):i[o]=a:i[o]=n(a,s):i[o]=s}return i};return n(e,t)},e}();e.Editor=f}(t.coui||(t.coui={}))});